# EmiyaOJ 在线判题系统 详细设计文档

## 第2部分：用户管理模块详细设计

---

## 4. 用户管理模块详细设计

### 4.1 模块概述

用户管理模块是系统的基础模块，实现了基于RBAC（Role-Based Access Control）的权限控制模型。模块包含三个核心实体：用户（User）、角色（Role）、权限（Permission），通过中间表实现多对多关联。

#### 4.1.1 模块架构

```
┌────────────────────────────────────────────────────────────────┐
│                    用户管理模块架构                              │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Controller层                                                  │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐  │
│  │UserController│ │RoleController│ │PermissionController  │  │
│  └──────────────┘ └──────────────┘ └──────────────────────┘  │
│         │                │                    │               │
│         ▼                ▼                    ▼               │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐  │
│  │IUserService  │ │IRoleService  │ │IPermissionService    │  │
│  └──────────────┘ └──────────────┘ └──────────────────────┘  │
│         │                │                    │               │
│         ▼                ▼                    ▼               │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐  │
│  │ UserMapper   │ │ RoleMapper   │ │ PermissionMapper     │  │
│  └──────────────┘ └──────────────┘ └──────────────────────┘  │
│         │                │                    │               │
│         ▼                ▼                    ▼               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                    MySQL数据库                          │  │
│  │  user   role   permission   user_role   role_permission│  │
│  └────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
```

#### 4.1.2 RBAC权限模型

```
┌────────┐         ┌───────────┐         ┌──────┐
│  User  │────N:M──│ user_role │────N:1──│ Role │
│ 用户   │         └───────────┘         └──────┘
└────────┘                                    │
                                              │N:M
                                              ▼
                                      ┌────────────────┐
                                      │role_permission │
                                      └────────────────┘
                                              │
                                              │N:1
                                              ▼
                                      ┌────────────┐
                                      │ Permission │
                                      │   权限     │
                                      └────────────┘
```

**权限传递路径**：
```
用户 → 角色 → 权限
```

---

### 4.2 用户管理（User）详细设计

#### 4.2.1 数据表设计

**表名**：`user`

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 唯一 | 默认值 | 说明 |
|--------|---------|------|------|------|------|--------|------|
| id | bigint | - | √ | √ | - | AUTO_INCREMENT | 用户ID |
| username | varchar | 50 | - | √ | √ | - | 用户名，登录账号 |
| password | varchar | 100 | - | √ | - | - | 密码，BCrypt加密 |
| nickname | varchar | 50 | - | - | - | NULL | 昵称 |
| email | varchar | 100 | - | - | √ | NULL | 邮箱 |
| phone | varchar | 20 | - | - | - | NULL | 手机号 |
| avatar | varchar | 255 | - | - | - | NULL | 头像URL |
| status | tinyint | - | - | √ | - | 1 | 状态：0-禁用，1-启用 |
| deleted | tinyint | - | - | √ | - | 0 | 删除标记：0-未删除，1-已删除 |
| create_time | datetime | - | - | √ | - | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | √ | - | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_username` (`username`)
- UNIQUE KEY `uk_email` (`email`)
- INDEX `idx_status` (`status`)
- INDEX `idx_create_time` (`create_time`)

**SQL DDL**：
```sql
CREATE TABLE `user` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `password` varchar(100) NOT NULL COMMENT '密码（BCrypt加密）',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `status` tinyint NOT NULL DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '删除标记：0-未删除，1-已删除',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='用户表';
```

#### 4.2.2 实体类设计 (User.java)

```java
package com.emiyaoj.service.domain.pojo;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * 用户实体类
 * 对应数据库表：user
 */
@Data
@TableName("user")
public class User implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 用户ID（主键，雪花算法生成）
     */
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;
    
    /**
     * 用户名（登录账号）
     */
    private String username;
    
    /**
     * 密码（BCrypt加密存储）
     */
    private String password;
    
    /**
     * 昵称（显示名称）
     */
    private String nickname;
    
    /**
     * 邮箱
     */
    private String email;
    
    /**
     * 手机号
     */
    private String phone;
    
    /**
     * 头像URL
     */
    private String avatar;
    
    /**
     * 状态：0-禁用，1-启用
     */
    private Integer status;
    
    /**
     * 逻辑删除标记：0-未删除，1-已删除
     */
    @TableLogic
    private Integer deleted;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
}
```

#### 4.2.3 DTO对象设计

**UserSaveDTO.java** - 用户保存（新增/修改）DTO

```java
package com.emiyaoj.service.domain.dto;

import jakarta.validation.constraints.*;
import lombok.Data;

/**
 * 用户保存DTO（用于新增和修改）
 */
@Data
public class UserSaveDTO {
    
    /**
     * 用户ID（修改时必填，新增时不填）
     */
    private Long id;
    
    /**
     * 用户名（3-20个字符）
     */
    @NotBlank(message = "用户名不能为空")
    @Size(min = 3, max = 20, message = "用户名长度为3-20个字符")
    @Pattern(regexp = "^[a-zA-Z0-9_]+$", message = "用户名只能包含字母、数字和下划线")
    private String username;
    
    /**
     * 密码（6-20个字符，新增时必填）
     */
    @Size(min = 6, max = 20, message = "密码长度为6-20个字符")
    private String password;
    
    /**
     * 昵称
     */
    @Size(max = 50, message = "昵称长度不能超过50个字符")
    private String nickname;
    
    /**
     * 邮箱
     */
    @Email(message = "邮箱格式不正确")
    private String email;
    
    /**
     * 手机号
     */
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;
    
    /**
     * 头像URL
     */
    private String avatar;
    
    /**
     * 状态（0-禁用，1-启用）
     */
    private Integer status;
}
```

**UserLoginDTO.java** - 用户登录DTO

```java
package com.emiyaoj.service.domain.dto;

import jakarta.validation.constraints.NotBlank;
import lombok.Data;

/**
 * 用户登录DTO
 */
@Data
public class UserLoginDTO {
    
    /**
     * 用户名
     */
    @NotBlank(message = "用户名不能为空")
    private String username;
    
    /**
     * 密码
     */
    @NotBlank(message = "密码不能为空")
    private String password;
}
```

#### 4.2.4 VO对象设计

**UserVO.java** - 用户视图对象

```java
package com.emiyaoj.service.domain.vo;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

/**
 * 用户视图对象
 * 返回给前端的用户信息（不包含密码等敏感信息）
 */
@Data
public class UserVO {
    
    /**
     * 用户ID
     */
    private Long id;
    
    /**
     * 用户名
     */
    private String username;
    
    /**
     * 昵称
     */
    private String nickname;
    
    /**
     * 邮箱
     */
    private String email;
    
    /**
     * 手机号
     */
    private String phone;
    
    /**
     * 头像URL
     */
    private String avatar;
    
    /**
     * 状态：0-禁用，1-启用
     */
    private Integer status;
    
    /**
     * 创建时间
     */
    private LocalDateTime createTime;
    
    /**
     * 更新时间
     */
    private LocalDateTime updateTime;
    
    /**
     * 用户角色列表
     */
    private List<RoleVO> roles;
    
    /**
     * 用户权限编码列表
     */
    private List<String> permissions;
}
```

**UserLoginVO.java** - 登录响应VO

```java
package com.emiyaoj.service.domain.vo;

import lombok.Data;
import lombok.AllArgsConstructor;

/**
 * 用户登录响应VO
 */
@Data
@AllArgsConstructor
public class UserLoginVO {
    
    /**
     * JWT Token
     */
    private String token;
    
    /**
     * 用户信息
     */
    private UserVO userInfo;
}
```

#### 4.2.5 Mapper接口设计

**UserMapper.java**

```java
package com.emiyaoj.service.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.emiyaoj.service.domain.pojo.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import java.util.List;

/**
 * 用户Mapper接口
 * 继承MyBatis-Plus BaseMapper，自动提供CRUD方法
 */
@Mapper
public interface UserMapper extends BaseMapper<User> {
    
    /**
     * 根据用户名查询用户（含软删除数据）
     * @param username 用户名
     * @return 用户对象
     */
    User selectByUsername(@Param("username") String username);
    
    /**
     * 根据邮箱查询用户
     * @param email 邮箱
     * @return 用户对象
     */
    User selectByEmail(@Param("email") String email);
    
    /**
     * 批量查询用户信息
     * @param ids 用户ID列表
     * @return 用户列表
     */
    List<User> selectBatchByIds(@Param("ids") List<Long> ids);
    
    /**
     * 获取用户的所有权限编码（通过角色）
     * @param userId 用户ID
     * @return 权限编码列表
     */
    List<String> selectUserPermissions(@Param("userId") Long userId);
    
    /**
     * 获取用户的所有角色编码
     * @param userId 用户ID
     * @return 角色编码列表
     */
    List<String> selectUserRoles(@Param("userId") Long userId);
}
```

**UserMapper.xml** - SQL映射配置

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.emiyaoj.service.mapper.UserMapper">
    
    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.emiyaoj.service.domain.pojo.User">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="nickname" property="nickname"/>
        <result column="email" property="email"/>
        <result column="phone" property="phone"/>
        <result column="avatar" property="avatar"/>
        <result column="status" property="status"/>
        <result column="deleted" property="deleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>
    
    <!-- 根据用户名查询（不使用逻辑删除） -->
    <select id="selectByUsername" resultMap="BaseResultMap">
        SELECT * FROM user
        WHERE username = #{username}
        LIMIT 1
    </select>
    
    <!-- 根据邮箱查询 -->
    <select id="selectByEmail" resultMap="BaseResultMap">
        SELECT * FROM user
        WHERE email = #{email}
        AND deleted = 0
        LIMIT 1
    </select>
    
    <!-- 批量查询用户 -->
    <select id="selectBatchByIds" resultMap="BaseResultMap">
        SELECT * FROM user
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND deleted = 0
    </select>
    
    <!-- 获取用户权限列表 -->
    <select id="selectUserPermissions" resultType="string">
        SELECT DISTINCT p.permission_code
        FROM permission p
        INNER JOIN role_permission rp ON p.id = rp.permission_id
        INNER JOIN user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND p.status = 1
          AND p.deleted = 0
    </select>
    
    <!-- 获取用户角色列表 -->
    <select id="selectUserRoles" resultType="string">
        SELECT r.role_code
        FROM role r
        INNER JOIN user_role ur ON r.id = ur.role_id
        WHERE ur.user_id = #{userId}
          AND r.status = 1
          AND r.deleted = 0
    </select>
    
</mapper>
```

#### 4.2.6 Service接口设计

**IUserService.java**

```java
package com.emiyaoj.service.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.emiyaoj.common.domain.PageDTO;
import com.emiyaoj.common.domain.PageVO;
import com.emiyaoj.service.domain.dto.UserLoginDTO;
import com.emiyaoj.service.domain.dto.UserSaveDTO;
import com.emiyaoj.service.domain.vo.UserLoginVO;
import com.emiyaoj.service.domain.vo.UserVO;
import com.emiyaoj.service.domain.pojo.User;
import java.util.List;

/**
 * 用户服务接口
 */
public interface IUserService extends IService<User> {
    
    /**
     * 用户登录
     * @param loginDTO 登录信息
     * @return 登录响应（包含Token和用户信息）
     */
    UserLoginVO login(UserLoginDTO loginDTO);
    
    /**
     * 分页查询用户列表
     * @param pageDTO 分页参数
     * @return 用户分页数据
     */
    PageVO<UserVO> selectUserPage(PageDTO pageDTO);
    
    /**
     * 根据ID查询用户信息
     * @param id 用户ID
     * @return 用户视图对象
     */
    UserVO selectUserById(Long id);
    
    /**
     * 根据用户名查询用户
     * @param username 用户名
     * @return 用户实体
     */
    User selectUserByUsername(String username);
    
    /**
     * 新增用户
     * @param saveDTO 用户保存DTO
     * @return 是否成功
     */
    boolean saveUser(UserSaveDTO saveDTO);
    
    /**
     * 修改用户
     * @param saveDTO 用户保存DTO
     * @return 是否成功
     */
    boolean updateUser(UserSaveDTO saveDTO);
    
    /**
     * 删除用户（逻辑删除）
     * @param id 用户ID
     * @return 是否成功
     */
    boolean deleteUser(Long id);
    
    /**
     * 批量删除用户
     * @param ids 用户ID列表
     * @return 是否成功
     */
    boolean deleteUsers(List<Long> ids);
    
    /**
     * 重置用户密码
     * @param id 用户ID
     * @param newPassword 新密码（明文）
     * @return 是否成功
     */
    boolean resetPassword(Long id, String newPassword);
    
    /**
     * 修改用户状态
     * @param id 用户ID
     * @param status 状态（0-禁用，1-启用）
     * @return 是否成功
     */
    boolean updateUserStatus(Long id, Integer status);
    
    /**
     * 为用户分配角色
     * @param userId 用户ID
     * @param roleIds 角色ID列表
     * @return 是否成功
     */
    boolean assignRoles(Long userId, List<Long> roleIds);
    
    /**
     * 获取用户的所有权限编码
     * @param userId 用户ID
     * @return 权限编码列表
     */
    List<String> getUserPermissions(Long userId);
    
    /**
     * 检查用户是否拥有指定权限
     * @param userId 用户ID
     * @param permissionCode 权限编码
     * @return true-拥有，false-不拥有
     */
    boolean hasPermission(Long userId, String permissionCode);
    
    /**
     * 检查用户是否拥有指定角色
     * @param userId 用户ID
     * @param roleCode 角色编码
     * @return true-拥有，false-不拥有
     */
    boolean hasRole(Long userId, String roleCode);
}
```

#### 4.2.7 Service实现类核心逻辑

**UserServiceImpl.java** - 关键方法实现

```java
package com.emiyaoj.service.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.emiyaoj.common.domain.PageDTO;
import com.emiyaoj.common.domain.PageVO;
import com.emiyaoj.common.exception.BusinessException;
import com.emiyaoj.common.utils.JwtUtil;
import com.emiyaoj.common.utils.RedisUtil;
import com.emiyaoj.service.domain.dto.UserLoginDTO;
import com.emiyaoj.service.domain.dto.UserSaveDTO;
import com.emiyaoj.service.domain.pojo.User;
import com.emiyaoj.service.domain.pojo.UserRole;
import com.emiyaoj.service.domain.vo.UserLoginVO;
import com.emiyaoj.service.domain.vo.UserVO;
import com.emiyaoj.service.mapper.UserMapper;
import com.emiyaoj.service.mapper.UserRoleMapper;
import com.emiyaoj.service.service.IUserService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.BeanUtils;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;

import java.util.*;
import java.util.stream.Collectors;

/**
 * 用户服务实现类
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {
    
    private final UserMapper userMapper;
    private final UserRoleMapper userRoleMapper;
    private final PasswordEncoder passwordEncoder;  // BCrypt密码加密器
    private final JwtUtil jwtUtil;
    private final RedisUtil redisUtil;
    
    /**
     * 用户登录
     * 流程：验证用户名密码 → 生成JWT Token → 存储到Redis → 返回Token和用户信息
     */
    @Override
    public UserLoginVO login(UserLoginDTO loginDTO) {
        // 1. 查询用户
        User user = userMapper.selectByUsername(loginDTO.getUsername());
        if (user == null) {
            throw new BusinessException("用户名或密码错误");
        }
        
        // 2. 验证密码（BCrypt）
        if (!passwordEncoder.matches(loginDTO.getPassword(), user.getPassword())) {
            throw new BusinessException("用户名或密码错误");
        }
        
        // 3. 检查用户状态
        if (user.getStatus() == 0) {
            throw new BusinessException("账号已被禁用");
        }
        
        // 4. 生成JWT Token
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", user.getId());
        claims.put("username", user.getUsername());
        String token = jwtUtil.createToken(claims);
        
        // 5. 存储Token到Redis（有效期2小时）
        String redisKey = "login:token:" + user.getId();
        Map<String, Object> tokenData = new HashMap<>();
        tokenData.put("token", token);
        tokenData.put("userId", user.getId());
        tokenData.put("username", user.getUsername());
        redisUtil.set(redisKey, tokenData, 7200); // 2小时
        
        // 6. 构造用户信息VO
        UserVO userVO = new UserVO();
        BeanUtils.copyProperties(user, userVO);
        userVO.setPermissions(getUserPermissions(user.getId()));
        
        // 7. 返回登录响应
        return new UserLoginVO(token, userVO);
    }
    
    /**
     * 分页查询用户列表
     */
    @Override
    public PageVO<UserVO> selectUserPage(PageDTO pageDTO) {
        // 1. 构造分页对象
        Page<User> page = new Page<>(pageDTO.getPageNum(), pageDTO.getPageSize());
        
        // 2. 查询数据库
        Page<User> userPage = this.page(page);
        
        // 3. 转换为VO对象
        List<UserVO> voList = userPage.getRecords().stream()
            .map(user -> {
                UserVO vo = new UserVO();
                BeanUtils.copyProperties(user, vo);
                return vo;
            })
            .collect(Collectors.toList());
        
        // 4. 封装分页结果
        PageVO<UserVO> pageVO = new PageVO<>();
        pageVO.setTotal(userPage.getTotal());
        pageVO.setList(voList);
        pageVO.setPageNum(pageDTO.getPageNum());
        pageVO.setPageSize(pageDTO.getPageSize());
        pageVO.setTotalPages((int) Math.ceil((double) userPage.getTotal() / pageDTO.getPageSize()));
        
        return pageVO;
    }
    
    /**
     * 新增用户
     * 流程：参数校验 → 用户名/邮箱唯一性检查 → 密码加密 → 插入数据库
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean saveUser(UserSaveDTO saveDTO) {
        // 1. 校验用户名唯一性
        User existUser = userMapper.selectByUsername(saveDTO.getUsername());
        if (existUser != null) {
            throw new BusinessException("用户名已存在");
        }
        
        // 2. 校验邮箱唯一性
        if (StringUtils.hasText(saveDTO.getEmail())) {
            existUser = userMapper.selectByEmail(saveDTO.getEmail());
            if (existUser != null) {
                throw new BusinessException("邮箱已被使用");
            }
        }
        
        // 3. 构造用户对象
        User user = new User();
        BeanUtils.copyProperties(saveDTO, user);
        
        // 4. 密码加密（BCrypt）
        if (StringUtils.hasText(saveDTO.getPassword())) {
            user.setPassword(passwordEncoder.encode(saveDTO.getPassword()));
        }
        
        // 5. 设置默认值
        if (user.getStatus() == null) {
            user.setStatus(1); // 默认启用
        }
        
        // 6. 插入数据库
        return this.save(user);
    }
    
    /**
     * 修改用户
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean updateUser(UserSaveDTO saveDTO) {
        // 1. 检查用户是否存在
        User existUser = this.getById(saveDTO.getId());
        if (existUser == null) {
            throw new BusinessException("用户不存在");
        }
        
        // 2. 如果修改了用户名，检查唯一性
        if (!existUser.getUsername().equals(saveDTO.getUsername())) {
            User user = userMapper.selectByUsername(saveDTO.getUsername());
            if (user != null) {
                throw new BusinessException("用户名已存在");
            }
        }
        
        // 3. 如果修改了邮箱，检查唯一性
        if (StringUtils.hasText(saveDTO.getEmail()) 
                && !saveDTO.getEmail().equals(existUser.getEmail())) {
            User user = userMapper.selectByEmail(saveDTO.getEmail());
            if (user != null) {
                throw new BusinessException("邮箱已被使用");
            }
        }
        
        // 4. 更新用户信息（不更新密码）
        User user = new User();
        BeanUtils.copyProperties(saveDTO, user);
        user.setPassword(null); // 不允许直接修改密码
        
        return this.updateById(user);
    }
    
    /**
     * 重置密码
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean resetPassword(Long id, String newPassword) {
        User user = new User();
        user.setId(id);
        user.setPassword(passwordEncoder.encode(newPassword));
        return this.updateById(user);
    }
    
    /**
     * 为用户分配角色
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean assignRoles(Long userId, List<Long> roleIds) {
        // 1. 删除用户原有角色
        LambdaQueryWrapper<UserRole> deleteWrapper = new LambdaQueryWrapper<>();
        deleteWrapper.eq(UserRole::getUserId, userId);
        userRoleMapper.delete(deleteWrapper);
        
        // 2. 批量插入新角色
        if (roleIds != null && !roleIds.isEmpty()) {
            List<UserRole> userRoles = roleIds.stream()
                .map(roleId -> {
                    UserRole userRole = new UserRole();
                    userRole.setUserId(userId);
                    userRole.setRoleId(roleId);
                    return userRole;
                })
                .collect(Collectors.toList());
            
            userRoleMapper.insertBatch(userRoles);
        }
        
        return true;
    }
    
    /**
     * 获取用户的所有权限编码
     */
    @Override
    public List<String> getUserPermissions(Long userId) {
        return userMapper.selectUserPermissions(userId);
    }
    
    /**
     * 检查用户是否拥有指定权限
     */
    @Override
    public boolean hasPermission(Long userId, String permissionCode) {
        List<String> permissions = getUserPermissions(userId);
        return permissions.contains(permissionCode);
    }
    
    /**
     * 检查用户是否拥有指定角色
     */
    @Override
    public boolean hasRole(Long userId, String roleCode) {
        List<String> roles = userMapper.selectUserRoles(userId);
        return roles.contains(roleCode);
    }
}
```

#### 4.2.8 Controller接口设计

**UserController.java** - RESTful API

```java
package com.emiyaoj.service.controller;

import com.emiyaoj.common.domain.PageDTO;
import com.emiyaoj.common.domain.PageVO;
import com.emiyaoj.common.domain.ResponseResult;
import com.emiyaoj.service.domain.dto.UserSaveDTO;
import com.emiyaoj.service.domain.vo.UserVO;
import com.emiyaoj.service.service.IUserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 用户管理控制器
 */
@Tag(name = "用户管理", description = "用户管理相关接口")
@RestController
@RequestMapping("/user")
@RequiredArgsConstructor
public class UserController {
    
    private final IUserService userService;
    
    @Operation(summary = "分页查询用户列表")
    @PostMapping("/page")
    @PreAuthorize("hasAuthority('USER.LIST')")
    public ResponseResult<PageVO<UserVO>> getUserPage(@Valid @RequestBody PageDTO pageDTO) {
        PageVO<UserVO> page = userService.selectUserPage(pageDTO);
        return ResponseResult.success(page);
    }
    
    @Operation(summary = "根据ID查询用户信息")
    @GetMapping("/{id}")
    @PreAuthorize("hasAuthority('USER.LIST')")
    public ResponseResult<UserVO> getUserById(@PathVariable Long id) {
        UserVO userVO = userService.selectUserById(id);
        return ResponseResult.success(userVO);
    }
    
    @Operation(summary = "新增用户")
    @PostMapping
    @PreAuthorize("hasAuthority('USER.ADD')")
    public ResponseResult<Void> saveUser(@Valid @RequestBody UserSaveDTO saveDTO) {
        boolean result = userService.saveUser(saveDTO);
        return result ? ResponseResult.success("新增用户成功") 
                      : ResponseResult.error("新增用户失败");
    }
    
    @Operation(summary = "修改用户")
    @PutMapping
    @PreAuthorize("hasAuthority('USER.EDIT')")
    public ResponseResult<Void> updateUser(@Valid @RequestBody UserSaveDTO saveDTO) {
        boolean result = userService.updateUser(saveDTO);
        return result ? ResponseResult.success("修改用户成功") 
                      : ResponseResult.error("修改用户失败");
    }
    
    @Operation(summary = "删除用户")
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('USER.DELETE')")
    public ResponseResult<Void> deleteUser(@PathVariable Long id) {
        boolean result = userService.deleteUser(id);
        return result ? ResponseResult.success("删除用户成功") 
                      : ResponseResult.error("删除用户失败");
    }
    
    @Operation(summary = "批量删除用户")
    @DeleteMapping("/batch")
    @PreAuthorize("hasAuthority('USER.DELETE')")
    public ResponseResult<Void> deleteUsers(@RequestBody List<Long> ids) {
        boolean result = userService.deleteUsers(ids);
        return result ? ResponseResult.success("批量删除用户成功") 
                      : ResponseResult.error("批量删除用户失败");
    }
    
    @Operation(summary = "重置用户密码")
    @PutMapping("/{id}/reset-password")
    @PreAuthorize("hasAuthority('USER.RESET.PASSWORD')")
    public ResponseResult<Void> resetPassword(
            @PathVariable Long id, 
            @RequestParam String newPassword) {
        boolean result = userService.resetPassword(id, newPassword);
        return result ? ResponseResult.success("重置密码成功") 
                      : ResponseResult.error("重置密码失败");
    }
    
    @Operation(summary = "修改用户状态")
    @PutMapping("/{id}/status")
    @PreAuthorize("hasAuthority('USER.EDIT')")
    public ResponseResult<Void> updateUserStatus(
            @PathVariable Long id, 
            @RequestParam Integer status) {
        boolean result = userService.updateUserStatus(id, status);
        return result ? ResponseResult.success("修改用户状态成功") 
                      : ResponseResult.error("修改用户状态失败");
    }
    
    @Operation(summary = "为用户分配角色")
    @PutMapping("/{id}/roles")
    @PreAuthorize("hasAuthority('USER.ASSIGN.ROLE')")
    public ResponseResult<Void> assignRoles(
            @PathVariable Long id, 
            @RequestBody List<Long> roleIds) {
        boolean result = userService.assignRoles(id, roleIds);
        return result ? ResponseResult.success("分配角色成功") 
                      : ResponseResult.error("分配角色失败");
    }
}
```

---

## 第2部分总结

本部分完成了用户管理（User）的详细设计，包括：

1. **数据表设计**：user表结构、索引、SQL DDL
2. **实体类设计**：User.java（MyBatis-Plus实体）
3. **DTO对象**：UserSaveDTO、UserLoginDTO
4. **VO对象**：UserVO、UserLoginVO
5. **Mapper层**：UserMapper接口、XML SQL映射
6. **Service层**：IUserService接口、UserServiceImpl核心逻辑
7. **Controller层**：UserController RESTful API

**下一部分预告：第2部分(续) - 角色管理与权限管理详细设计**

将继续完成：
- 角色管理（Role）详细设计
- 权限管理（Permission）详细设计
- 用户-角色-权限关联表设计
- RBAC权限控制实现

---

*EmiyaOJ详细设计文档 - 第2部分结束*
