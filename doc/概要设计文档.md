# EmiyaOJ 在线判题系统 概要设计文档

## 文档信息

| 项目名称 | EmiyaOJ 在线判题系统 |
|----------|---------------------|
| 文档版本 | V1.0 |
| 创建日期 | 2026年1月7日 |
| 文档类型 | 概要设计文档 |

---

## 1. 引言

### 1.1 编写目的

本文档是EmiyaOJ在线判题系统的概要设计文档，旨在描述系统的整体架构设计、模块划分、接口设计、数据库设计等内容，为后续的详细设计和开发工作提供指导依据。

### 1.2 项目背景

EmiyaOJ是一个基于Spring Boot 3.x的在线判题系统（Online Judge），旨在提供代码提交、自动判题、用户管理、博客交流等一站式编程学习平台。系统采用前后端分离架构，集成go-judge判题引擎，实现安全、准确、高效的代码自动评测功能。

### 1.3 参考资料

- [需求分析文档.md](需求分析文档.md)
- [emiya-oj_final.sql](../database/emiya-oj_final.sql)
- Spring Boot 3.5.5 官方文档
- go-judge 项目文档

---

## 2. 系统总体设计

### 2.1 设计原则

| 原则 | 说明 |
|------|------|
| 高内聚低耦合 | 模块功能单一，模块间依赖关系清晰 |
| 分层架构 | 采用Controller-Service-Mapper三层架构 |
| 安全优先 | 代码沙箱隔离执行，JWT无状态认证，RBAC权限控制 |
| 可扩展性 | 支持动态添加编程语言，模块化设计便于功能扩展 |
| 异步处理 | 判题任务异步执行，避免阻塞用户请求 |

### 2.2 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端应用层                                       │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                 │
│    │   Vue 3.5    │    │ TypeScript   │    │ Element Plus │                 │
│    └──────────────┘    └──────────────┘    └──────────────┘                 │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                 │
│    │    Vite      │    │    Pinia     │    │Monaco Editor │                 │
│    └──────────────┘    └──────────────┘    └──────────────┘                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ HTTP/HTTPS (RESTful API)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              后端应用层                                       │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                         Spring Boot 3.5.5                               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │Spring       │  │Spring       │  │Spring Data  │  │SpringDoc    │   │ │
│  │  │Security     │  │Web MVC      │  │Redis        │  │OpenAPI      │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│  │  │MyBatis-Plus │  │JWT (jjwt)   │  │FastJSON2    │  │Lombok       │   │ │
│  │  │3.5.13       │  │0.12.6       │  │2.0.58       │  │             │   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    ▼               ▼               ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐
│   MySQL     │  │   Redis     │  │       go-judge          │
│   8.0.44    │  │   缓存      │  │     判题沙箱引擎          │
│  数据持久化   │  │  Token管理  │  │   安全代码执行环境        │
└─────────────┘  └─────────────┘  └─────────────────────────┘
```

### 2.3 技术选型

#### 2.3.1 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Java | 21 | 开发语言 |
| Spring Boot | 3.5.5 | 后端核心框架 |
| Spring Security | 6.x | 安全框架 |
| Spring Data Redis | - | Redis操作 |
| MyBatis-Plus | 3.5.13 | ORM框架 |
| MySQL | 8.0.44 | 关系型数据库 |
| Redis | - | 缓存中间件 |
| jjwt | 0.12.6 | JWT令牌生成与解析 |
| FastJSON2 | 2.0.58 | JSON处理 |
| go-judge | - | 代码判题引擎 |
| SpringDoc OpenAPI | 2.8.9 | API文档生成 |
| Lombok | - | 简化代码 |

#### 2.3.2 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue | 3.5 | 前端框架 |
| Vite | 5.x | 构建工具 |
| TypeScript | 5.x | 开发语言 |
| Element Plus | - | UI组件库 |
| Pinia | - | 状态管理 |
| Monaco Editor | - | 代码编辑器 |

---

## 3. 系统模块设计

### 3.1 模块划分

系统采用Maven多模块结构，分为两个主要模块：

```
EmiyaOJ/
├── pom.xml                    # 父工程POM（聚合模块）
├── oj-common/                 # 公共模块
│   ├── pom.xml
│   └── src/main/java/com/emiyaoj/common/
│       ├── config/            # 通用配置类
│       ├── constant/          # 常量定义
│       ├── domain/            # 通用领域对象
│       ├── exception/         # 异常类
│       ├── filter/            # 过滤器
│       ├── handler/           # 处理器
│       ├── properties/        # 配置属性
│       └── utils/             # 工具类
│
└── oj-service/                # 服务模块
    ├── pom.xml
    └── src/main/java/com/emiyaoj/service/
        ├── OjApplication.java # 启动类
        ├── config/            # 服务配置
        ├── controller/        # 控制器层
        │   └── client/        # 客户端API控制器
        ├── domain/            # 领域对象
        │   ├── dto/           # 数据传输对象
        │   ├── enums/         # 枚举类
        │   ├── pojo/          # 实体类
        │   └── vo/            # 视图对象
        ├── mapper/            # 数据访问层
        ├── service/           # 服务层
        │   └── impl/          # 服务实现
        └── util/              # 判题工具类
            └── oj/            # go-judge模型
```

### 3.2 模块依赖关系

```
┌─────────────────────────────────────────────┐
│              EmiyaOJ (Parent)               │
│            聚合模块，统一版本管理               │
└─────────────────────────────────────────────┘
                      │
          ┌───────────┴───────────┐
          ▼                       ▼
┌─────────────────┐    ┌─────────────────────┐
│   oj-common     │◄───│     oj-service      │
│   公共模块       │    │     服务模块         │
│                 │    │                     │
│ - JWT工具类      │    │ - Controller层      │
│ - Redis工具类    │    │ - Service层         │
│ - 异常处理       │    │ - Mapper层          │
│ - 通用响应对象   │    │ - 判题引擎集成       │
│ - 安全处理器     │    │ - 业务逻辑实现       │
└─────────────────┘    └─────────────────────┘
```

### 3.3 功能模块划分

系统按业务功能划分为四大模块：

| 模块 | 功能 | 主要组件 |
|------|------|----------|
| 用户管理模块 | 用户、角色、权限的CRUD和RBAC权限控制 | UserController, RoleController, PermissionController |
| 在线判题模块 | 题目管理、代码提交、自动判题 | ProblemController, ClientSubmissionController |
| 博客模块 | 博客发布、评论、收藏功能 | BlogController, ClientBlogController |
| 系统管理模块 | 操作日志、系统监控 | OperationLogController |

---

## 4. 系统接口设计

### 4.1 接口分层设计

系统API分为两类：
- **管理端API**：需要特定权限，用于后台管理（路径前缀：`/user`, `/role`, `/permission`, `/problem`, `/testcase`等）
- **客户端API**：面向普通用户（路径前缀：`/client/*`）

### 4.2 统一响应格式

```java
@Data
public class ResponseResult<T> {
    private int code;      // 状态码
    private String msg;    // 消息
    private T data;        // 数据
}
```

**成功响应示例**：
```json
{
  "code": 200,
  "msg": "Success",
  "data": { ... }
}
```

**分页响应格式**：
```java
@Data
public class PageVO<T> {
    private Long total;      // 总记录数
    private Long pages;      // 总页数
    private List<T> list;    // 数据列表
}
```

### 4.3 错误码定义

| 状态码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 权限不足 |
| 404 | 资源未找到 |
| 409 | 资源冲突（如用户已登录） |
| 500 | 服务器内部错误 |

### 4.4 核心接口设计

#### 4.4.1 认证接口

| 接口路径 | 方法 | 说明 | 权限 |
|----------|------|------|------|
| `/auth/login` | POST | 用户登录，返回JWT Token | 公开 |
| `/auth/logout` | POST | 用户登出，清除Token | 认证 |

#### 4.4.2 用户管理接口

| 接口路径 | 方法 | 说明 | 权限码 |
|----------|------|------|--------|
| `/user/page` | POST | 分页查询用户 | USER.LIST |
| `/user/{id}` | GET | 获取用户详情 | USER.LIST |
| `/user` | POST | 创建用户 | USER.ADD |
| `/user` | PUT | 修改用户 | USER.EDIT |
| `/user/{id}` | DELETE | 删除用户 | USER.DELETE |
| `/user/batch` | DELETE | 批量删除用户 | USER.DELETE |
| `/user/{id}/reset-password` | PUT | 重置密码 | USER.RESET.PASSWORD |
| `/user/{id}/status` | PUT | 修改用户状态 | USER.EDIT |
| `/user/{id}/roles` | PUT | 分配角色 | USER.ASSIGN.ROLE |

#### 4.4.3 角色管理接口

| 接口路径 | 方法 | 说明 | 权限码 |
|----------|------|------|--------|
| `/role/page` | GET | 分页查询角色 | ROLE.LIST |
| `/role/list` | GET | 获取角色列表 | ROLE.LIST |
| `/role/{id}` | GET | 获取角色详情 | ROLE.LIST |
| `/role` | POST | 创建角色 | ROLE.ADD |
| `/role` | PUT | 修改角色 | ROLE.EDIT |
| `/role/{id}` | DELETE | 删除角色 | ROLE.DELETE |
| `/role/{id}/permissions` | PUT | 分配权限 | ROLE.ASSIGN.PERMISSION |

#### 4.4.4 权限管理接口

| 接口路径 | 方法 | 说明 | 权限码 |
|----------|------|------|--------|
| `/permission/tree` | GET | 获取权限树 | PERMISSION.LIST |
| `/permission/list` | GET | 获取权限列表 | PERMISSION.LIST |
| `/permission/{id}` | GET | 获取权限详情 | PERMISSION.LIST |
| `/permission` | POST | 创建权限 | PERMISSION.ADD |
| `/permission` | PUT | 修改权限 | PERMISSION.EDIT |
| `/permission/{id}` | DELETE | 删除权限 | PERMISSION.DELETE |
| `/permission/user/{userId}` | GET | 获取用户权限 | 认证 |
| `/permission/menu/{userId}` | GET | 获取用户菜单 | 认证 |

#### 4.4.5 题目管理接口

| 接口路径 | 方法 | 说明 | 权限码 |
|----------|------|------|--------|
| `/problem/page` | GET | 分页查询题目 | 公开 |
| `/problem/{id}` | GET | 获取题目详情 | 公开 |
| `/problem` | POST | 创建题目 | PROBLEM.ADD |
| `/problem` | PUT | 修改题目 | PROBLEM.EDIT |
| `/problem/{id}` | DELETE | 删除题目 | PROBLEM.DELETE |
| `/problem/batch` | DELETE | 批量删除题目 | PROBLEM.DELETE |
| `/problem/{id}/status` | PUT | 修改题目状态 | PROBLEM.EDIT |

#### 4.4.6 代码提交接口（客户端）

| 接口路径 | 方法 | 说明 | 权限 |
|----------|------|------|------|
| `/client/submission/submit` | POST | 提交代码 | 认证 |
| `/client/submission/page` | GET | 分页查询提交记录 | 认证 |
| `/client/submission/{id}` | GET | 获取提交详情 | 认证 |

#### 4.4.7 博客接口（客户端）

| 接口路径 | 方法 | 说明 | 权限 |
|----------|------|------|------|
| `/client/blog` | GET | 查询博客列表 | 公开 |
| `/client/blog` | POST | 发布博客 | 认证 |
| `/client/blog/query` | POST | 条件查询博客 | 公开 |
| `/client/blog/{bid}` | GET | 获取博客详情 | 公开 |
| `/client/blog/{bid}` | PUT | 修改博客 | 认证 |
| `/client/blog/{bid}` | DELETE | 删除博客 | 认证 |

---

## 5. 数据库设计

### 5.1 数据库概述

- **数据库类型**：MySQL 8.0.44
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci / utf8mb4_general_ci
- **存储引擎**：InnoDB

### 5.2 E-R关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户管理模块                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────┐     ┌───────────┐     ┌──────┐                     │
│  │  user  │──N:M──│ user_role │──N:1──│ role │                 │
│  └────────┘     └───────────┘     └──────┘                     │
│                                      │                         │
│                                      │N:M                      │
│                                      ▼                         │
│                              ┌────────────────┐                │
│                              │role_permission │                │
│                              └────────────────┘                │
│                                      │                         │
│                                      │N:1                      │
│                                      ▼                         │
│                              ┌────────────┐                    │
│                              │ permission │                    │
│                              └────────────┘                    │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          判题模块                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────┐    1:N    ┌───────────┐                           │
│  │ problem │──────────│ test_case │                            │
│  └─────────┘           └───────────┘                           │
│       │                      ▲                                 │
│       │N:M                   │N:1                              │
│       ▼                      │                                 │
│  ┌─────────────┐    ┌────────────────────┐                     │
│  │ problem_tag │    │ submission_result  │                     │
│  └─────────────┘    └────────────────────┘                     │
│       │                      ▲                                 │
│       │N:1                   │1:N                              │
│       ▼                      │                                 │
│  ┌─────────┐         ┌────────────┐                            │
│  │   tag   │         │ submission │                            │
│  └─────────┘         └────────────┘                            │
│                           │  │  │                              │
│                      N:1  │  │  │  N:1                         │
│                 ┌─────────┘  │  └─────────┐                    │
│                 ▼            │            ▼                    │
│           ┌─────────┐       N:1    ┌──────────┐                │
│           │ problem │        │     │ language │                │
│           └─────────┘        │     └──────────┘                │
│                              ▼                                 │
│                         ┌────────┐                             │
│                         │  user  │                             │
│                         └────────┘                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          博客模块                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌────────┐   N:1   ┌────────┐   1:N   ┌──────────────┐        │
│  │  user  │◄───────│  blog  │────────│ blog_comment │         │
│  └────────┘         └────────┘         └──────────────┘        │
│       │                 │                    │                 │
│       │                 │N:M                 │N:1              │
│       │                 ▼                    ▼                 │
│       │    ┌─────────────────────────┐  ┌────────┐             │
│       │    │ blog_tag_association    │  │  user  │             │
│       │    └─────────────────────────┘  └────────┘             │
│       │                 │                                      │
│       │                 │N:1                                   │
│       │                 ▼                                      │
│       │         ┌───────────┐                                  │
│       │         │ blog_tag  │                                  │
│       │         └───────────┘                                  │
│       │                                                        │
│       │N:M    ┌───────────┐         ┌───────────┐              │
│       └──────│ blog_star │────N:1──│   blog    │              │
│               └───────────┘         └───────────┘              │
│                                                                │
│  ┌───────────┐   1:1   ┌────────┐                              │
│  │ user_blog │────────│  user  │   （统计表）                   │
│  └───────────┘         └────────┘                              │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 数据表清单

| 序号 | 表名 | 说明 | 所属模块 |
|------|------|------|----------|
| 1 | user | 用户表 | 用户管理 |
| 2 | role | 角色表 | 用户管理 |
| 3 | permission | 权限表 | 用户管理 |
| 4 | user_role | 用户角色关联表 | 用户管理 |
| 5 | role_permission | 角色权限关联表 | 用户管理 |
| 6 | language | 编程语言表 | 在线判题 |
| 7 | problem | 题目表 | 在线判题 |
| 8 | tag | 题目标签表 | 在线判题 |
| 9 | problem_tag | 题目标签关联表 | 在线判题 |
| 10 | test_case | 测试用例表 | 在线判题 |
| 11 | submission | 提交记录表 | 在线判题 |
| 12 | submission_result | 判题结果表 | 在线判题 |
| 13 | blog | 博客表 | 博客模块 |
| 14 | blog_comment | 博客评论表 | 博客模块 |
| 15 | blog_star | 博客收藏表 | 博客模块 |
| 16 | blog_tag | 博客标签表 | 博客模块 |
| 17 | blog_tag_association | 博客标签关联表 | 博客模块 |
| 18 | blog_picture | 博客图片表 | 博客模块 |
| 19 | user_blog | 用户博客统计表 | 博客模块 |
| 20 | operation_log | 操作日志表 | 系统管理 |

### 5.4 核心表结构设计

#### 5.4.1 用户表（user）

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | bigint | 用户ID | 主键，自增 |
| username | varchar(50) | 用户名 | 唯一，非空 |
| password | varchar(100) | 密码 | 非空，BCrypt加密 |
| nickname | varchar(50) | 昵称 | 可选 |
| email | varchar(100) | 邮箱 | 唯一 |
| phone | varchar(20) | 手机号 | 可选 |
| avatar | varchar(255) | 头像URL | 可选 |
| status | tinyint | 状态 | 0-禁用，1-启用 |
| deleted | tinyint | 删除标记 | 0-未删除，1-已删除 |
| create_time | datetime | 创建时间 | 默认当前时间 |
| update_time | datetime | 更新时间 | 自动更新 |

#### 5.4.2 角色表（role）

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | bigint | 角色ID | 主键，自增 |
| role_code | varchar(50) | 角色编码 | 唯一，非空 |
| role_name | varchar(50) | 角色名称 | 非空 |
| description | varchar(255) | 角色描述 | 可选 |
| status | tinyint | 状态 | 0-禁用，1-启用 |
| deleted | tinyint | 删除标记 | 软删除 |
| create_time | datetime | 创建时间 | 默认当前时间 |
| update_time | datetime | 更新时间 | 自动更新 |
| create_by | bigint | 创建者 | 可选 |
| update_by | bigint | 更新者 | 可选 |

#### 5.4.3 权限表（permission）

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | bigint | 权限ID | 主键，自增 |
| parent_id | bigint | 父权限ID | 默认0 |
| permission_code | varchar(255) | 权限编码 | 唯一，非空 |
| permission_name | varchar(50) | 权限名称 | 非空 |
| permission_type | tinyint | 权限类型 | 1-菜单，2-按钮，3-接口 |
| path | varchar(255) | 路由路径 | 可选 |
| component | varchar(255) | 组件路径 | 可选 |
| icon | varchar(50) | 图标 | 可选 |
| sort_order | int | 排序 | 默认0 |
| status | tinyint | 状态 | 0-禁用，1-启用 |
| deleted | tinyint | 删除标记 | 软删除 |

#### 5.4.4 题目表（problem）

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | bigint | 题目ID | 主键，自增 |
| title | varchar(255) | 题目标题 | 非空 |
| description | text | 题目描述 | 非空 |
| input_description | text | 输入描述 | 可选 |
| output_description | text | 输出描述 | 可选 |
| sample_input | text | 样例输入 | 可选 |
| sample_output | text | 样例输出 | 可选 |
| hint | text | 提示信息 | 可选 |
| difficulty | tinyint | 难度 | 1-简单，2-中等，3-困难 |
| time_limit | int | CPU时间限制(毫秒) | 非空 |
| memory_limit | int | 内存限制(MB) | 非空 |
| stack_limit | int | 栈内存限制(MB) | 默认128 |
| source | varchar(255) | 题目来源 | 可选 |
| author_id | bigint | 出题人ID | 可选 |
| accept_count | int | 通过次数 | 默认0 |
| submit_count | int | 提交次数 | 默认0 |
| status | tinyint | 状态 | 0-隐藏，1-公开 |
| deleted | tinyint | 删除标记 | 软删除 |

#### 5.4.5 提交记录表（submission）

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | bigint | 提交ID | 主键，自增 |
| problem_id | bigint | 题目ID | 非空，外键 |
| user_id | bigint | 用户ID | 非空，外键 |
| language_id | bigint | 语言ID | 非空，外键 |
| code | longtext | 源代码 | 非空 |
| status | varchar(50) | 判题状态 | 非空 |
| score | int | 得分 | 默认0 |
| time_used | int | 使用时间(毫秒) | 默认0 |
| memory_used | int | 使用内存(KB) | 默认0 |
| error_message | text | 错误信息 | 可选 |
| compile_message | text | 编译信息 | 可选 |
| pass_rate | varchar(50) | 通过率 | 如"10/10" |
| ip_address | varchar(50) | 提交IP | 可选 |
| create_time | datetime | 提交时间 | 默认当前时间 |
| update_time | datetime | 更新时间 | 自动更新 |

### 5.5 数据库触发器

系统使用数据库触发器自动维护统计数据：

| 触发器名称 | 触发表 | 触发时机 | 功能 |
|------------|--------|----------|------|
| after_blog_insert | blog | INSERT后 | 自动增加用户的blog_count |
| after_blog_delete | blog | UPDATE后 | 博客软删除时自动减少blog_count |
| after_blog_star_insert | blog_star | INSERT后 | 自动增加用户的star_count |
| after_blog_star_delete | blog_star | DELETE后 | 自动减少用户的star_count |
| after_user_username_update | user | UPDATE后 | 同步更新user_blog的username |
| after_user_nickname_update | user | UPDATE后 | 同步更新user_blog的nickname |

---

## 6. 安全设计

### 6.1 认证机制

系统采用JWT（JSON Web Token）无状态认证机制：

```
┌─────────────┐                              ┌─────────────┐
│   客户端     │                              │   服务端     │
└─────────────┘                              └─────────────┘
       │                                            │
       │  1. POST /auth/login                       │
       │     {username, password}                   │
       │───────────────────────────────────────────►│
       │                                            │
       │  2. 验证用户名密码                          │
       │     生成JWT Token                          │
       │     存储Token到Redis                       │
       │◄───────────────────────────────────────────│
       │  {code:200, data:{token:xxx}}              │
       │                                            │
       │  3. 携带Token请求API                       │
       │     Header: Authorization: Bearer {token}  │
       │───────────────────────────────────────────►│
       │                                            │
       │  4. JwtTokenOncePerRequestFilter           │
       │     验证Token有效性                         │
       │     解析用户信息到SecurityContext          │
       │◄───────────────────────────────────────────│
       │                                            │
```

**JWT配置参数**：
- 签名算法：HMAC-SHA256
- 过期时间：7200000毫秒（2小时）
- Token名称：Authorization

### 6.2 权限控制

系统采用RBAC（基于角色的访问控制）模型：

```
用户(User) ──N:M──► 角色(Role) ──N:M──► 权限(Permission)
```

**权限校验流程**：

```
请求 → JwtTokenFilter → SecurityContext → @PreAuthorize → Controller
                              │
                              ▼
                     用户权限列表
                     (从Token解析)
```

**权限注解示例**：
```java
@PreAuthorize("hasAuthority('USER.LIST')")
public ResponseResult<PageVO<UserVO>> getUserPage(...) { }
```

### 6.3 安全配置

Spring Security核心配置：

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {
    
    // 白名单路径
    private final String[] whitelist = {
        "/auth/login",
        "/swagger-ui/**",
        "/v3/api-docs/**"
    };
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http.cors()                          // 启用CORS
            .csrf(AbstractHttpConfigurer::disable)  // 禁用CSRF
            .sessionManagement()
            .sessionCreationPolicy(STATELESS)  // 无状态会话
            .authorizeHttpRequests()
            .requestMatchers(whitelist).permitAll()  // 白名单放行
            .anyRequest().authenticated()     // 其他请求需认证
            .addFilterBefore(jwtTokenFilter,  // 添加JWT过滤器
                UsernamePasswordAuthenticationFilter.class);
    }
}
```

### 6.4 代码沙箱安全

go-judge判题引擎提供的安全机制：

| 安全措施 | 说明 |
|----------|------|
| 资源限制 | CPU时间、内存、进程数限制 |
| 文件系统隔离 | 代码在沙箱中执行，无法访问系统文件 |
| 网络隔离 | 禁止网络访问 |
| 系统调用限制 | 限制可用的系统调用 |

---

## 7. 判题引擎设计

### 7.1 判题流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         判题流程图                               │
└─────────────────────────────────────────────────────────────────┘

     ┌──────────────┐
     │  用户提交代码  │
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │ 创建提交记录  │ status = Pending
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │ 启动异步判题  │ @Async
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐
     │ 更新状态为   │ status = Judging
     │   Judging    │
     └──────┬───────┘
            │
            ▼
     ┌──────────────┐     失败     ┌─────────────────┐
     │   编译代码    │────────────►│ Compile Error  │
     │  (如需要)    │             └─────────────────┘
     └──────┬───────┘
            │ 成功
            ▼
     ┌──────────────┐
     │  获取测试用例 │
     └──────┬───────┘
            │
            ▼
    ┌───────────────────┐
    │ 循环执行测试用例   │
    │                   │
    │  ┌─────────────┐  │
    │  │ 执行程序    │  │
    │  │ 比较输出    │  │
    │  │ 记录结果    │  │
    │  └─────────────┘  │
    └─────────┬─────────┘
              │
              ▼
     ┌──────────────┐
     │ 更新提交状态  │
     │ 计算通过率   │
     │ 更新题目统计 │
     └──────┬───────┘
              │
              ▼
     ┌──────────────┐
     │ 清理临时文件  │
     └──────────────┘
```

### 7.2 判题状态

| 状态 | 说明 | 含义 |
|------|------|------|
| Pending | 等待判题 | 提交已创建，等待处理 |
| Judging | 判题中 | 正在编译或执行测试用例 |
| Accepted | 通过 | 所有测试用例通过 |
| Wrong Answer | 答案错误 | 输出与预期不符 |
| Time Limit Exceeded | 超时 | 运行时间超过限制 |
| Memory Limit Exceeded | 内存超限 | 内存使用超过限制 |
| Runtime Error | 运行时错误 | 程序运行异常（段错误等） |
| Compile Error | 编译错误 | 代码编译失败 |
| System Error | 系统错误 | 判题系统异常 |

### 7.3 go-judge集成

**GoJudgeService**：封装go-judge HTTP API调用

```java
@Service
public class GoJudgeService {
    
    @Value("${GoJudge.url}")
    private String goJudgeUrl;
    
    public List<Result> execute(Request request) {
        String url = goJudgeUrl + "/run";
        // 发送POST请求执行判题
    }
    
    public void deleteFile(String fileId) {
        // 删除缓存的可执行文件
    }
}
```

**GoJudgeRequestBuilder**：构建判题请求

```java
@UtilityClass
public class GoJudgeRequestBuilder {
    
    // 构建C++编译请求
    public static Request buildCppCompileRequest(String sourceCode, String outputName);
    
    // 构建C编译请求
    public static Request buildCCompileRequest(String sourceCode, String outputName);
    
    // 构建运行请求
    public static Request buildRunRequest(String executableFileId, String input, 
                                          String executableName, Long cpuLimit, Long memoryLimit);
}
```

### 7.4 支持的编程语言

| 语言 | 编译器/解释器 | 编译命令 | 文件扩展名 |
|------|---------------|----------|------------|
| C | gcc | `/usr/bin/gcc source.c -o main` | .c |
| C++ | g++ | `/usr/bin/g++ source.cpp -o main` | .cpp |

---

## 8. 领域模型设计

### 8.1 实体类设计

系统采用分层的领域对象设计：

| 类型 | 包路径 | 说明 | 示例 |
|------|--------|------|------|
| POJO | domain.pojo | 数据库实体类 | User, Problem, Submission |
| DTO | domain.dto | 数据传输对象（输入） | UserLoginDTO, SubmitCodeDTO |
| VO | domain.vo | 视图对象（输出） | UserVO, ProblemVO, SubmissionVO |
| Enum | domain.enums | 枚举类 | - |

### 8.2 核心实体关系

```
┌─────────────────────────────────────────────────────────────┐
│                       实体类关系图                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌────────┐                    ┌────────────┐              │
│  │  User  │───────────────────│ UserLogin  │              │
│  └────────┘                    └────────────┘              │
│       │                              │                     │
│       │ 1:N                          │ 包含                │
│       ▼                              ▼                     │
│  ┌────────────┐              ┌─────────────────┐          │
│  │ Submission │              │ UserPermission  │          │
│  └────────────┘              │    (权限列表)    │          │
│       │                      └─────────────────┘          │
│       │ 1:N                                               │
│       ▼                                                   │
│  ┌────────────────────┐                                   │
│  │  SubmissionResult  │                                   │
│  └────────────────────┘                                   │
│                                                           │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 DTO示例

**代码提交DTO**：
```java
@Data
public class SubmitCodeDTO {
    private Long problemId;    // 题目ID
    private Long languageId;   // 语言ID
    private String code;       // 源代码
}
```

**用户登录DTO**：
```java
@Data
public class UserLoginDTO {
    private String username;   // 用户名
    private String password;   // 密码
}
```

### 8.4 VO示例

**提交记录VO**：
```java
@Data
public class SubmissionVO {
    private Long id;
    private Long problemId;
    private String problemTitle;
    private Long userId;
    private String username;
    private Long languageId;
    private String languageName;
    private String code;
    private String status;
    private Integer score;
    private Integer timeUsed;
    private Integer memoryUsed;
    private String passRate;
    private List<SubmissionResultVO> results;  // 测试用例结果
}
```

---

## 9. 异常处理设计

### 9.1 异常类层次

```
BaseException (基础异常)
    │
    ├── BadRequestException (请求参数错误 - 400)
    │
    └── CustomerAuthenticationException (认证异常 - 401)
```

### 9.2 全局异常处理

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BadRequestException.class)
    public ResponseResult<?> handleBadRequest(BadRequestException e) {
        return ResponseResult.fail(400, e.getMessage());
    }
    
    @ExceptionHandler(CustomerAuthenticationException.class)
    public ResponseResult<?> handleAuthException(CustomerAuthenticationException e) {
        return ResponseResult.fail(401, e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public ResponseResult<?> handleException(Exception e) {
        return ResponseResult.fail(500, "服务器内部错误");
    }
}
```

### 9.3 安全异常处理器

| 处理器 | 功能 |
|--------|------|
| AnonymousAuthenticationHandler | 处理匿名用户访问受保护资源 |
| CustomerAccessDeniedHandler | 处理认证用户无权限访问 |
| LoginFailureHandler | 处理登录失败异常 |

---

## 10. 配置管理

### 10.1 应用配置结构

```yaml
# application.yaml 配置结构

server:
  port: 8080                    # 服务端口

spring:
  application:
    name: oj-service            # 应用名称
  datasource:                   # 数据源配置
    url: jdbc:mysql://...
    username: root
    password: ****
  data:
    redis:                      # Redis配置
      host: localhost
      port: 6379

jwt:                            # JWT配置
  secret-key: xxx               # 签名密钥（至少32字符）
  ttl: 7200000                  # 过期时间（毫秒）
  token-name: Authorization     # Token名称

GoJudge:                        # 判题引擎配置
  url: http://localhost:12812   # go-judge服务地址

mybatis-plus:                   # MyBatis-Plus配置
  configuration:
    default-enum-type-handler: ...
  global-config:
    db-config:
      id-type: assign_id        # 主键生成策略
  mapper-locations: classpath:/mapper/**/*.xml

springdoc:                      # API文档配置
  swagger-ui:
    path: /swagger-ui.html
```

### 10.2 环境配置

| 配置项 | 开发环境 | 生产环境 |
|--------|----------|----------|
| server.port | 8080 | 8080 |
| logging.level | DEBUG | INFO |
| spring.datasource.url | 本地MySQL | 生产MySQL |
| GoJudge.url | 本地/测试服务器 | 生产服务器 |

---

## 11. 部署架构

### 11.1 部署拓扑图

```
                         ┌─────────────────┐
                         │    Nginx        │
                         │  反向代理/负载均衡 │
                         └────────┬────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
                    ▼             ▼             ▼
           ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
           │ OJ-Service  │ │ OJ-Service  │ │ OJ-Service  │
           │  实例 1      │ │  实例 2      │ │  实例 N      │
           └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
                  │               │               │
                  └───────────────┼───────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
           ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
           │   MySQL     │ │   Redis     │ │  go-judge   │
           │   主数据库   │ │   缓存集群   │ │  判题集群    │
           └─────────────┘ └─────────────┘ └─────────────┘
```

### 11.2 系统要求

| 组件 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 磁盘 | 50GB | 100GB+ SSD |
| JDK | 21 | 21 |
| MySQL | 8.0 | 8.0+ |
| Redis | 6.0 | 7.0+ |

---

## 12. 附录

### 12.1 术语表

| 术语 | 全称 | 说明 |
|------|------|------|
| OJ | Online Judge | 在线判题系统 |
| AC | Accepted | 代码通过所有测试用例 |
| WA | Wrong Answer | 答案错误 |
| TLE | Time Limit Exceeded | 超时 |
| MLE | Memory Limit Exceeded | 内存超限 |
| RE | Runtime Error | 运行时错误 |
| CE | Compile Error | 编译错误 |
| RBAC | Role-Based Access Control | 基于角色的访问控制 |
| JWT | JSON Web Token | JSON网络令牌 |
| DTO | Data Transfer Object | 数据传输对象 |
| VO | View Object | 视图对象 |
| POJO | Plain Old Java Object | 简单Java对象 |

### 12.2 文件目录说明

```
EmiyaOJ/
├── pom.xml                    # 父工程Maven配置
├── mvnw, mvnw.cmd             # Maven Wrapper
├── database/                  # 数据库脚本目录
│   ├── emiya-oj_final.sql     # 完整数据库脚本
│   └── blog/                  # 博客模块脚本
├── doc/                       # 文档目录
│   ├── 需求分析文档.md
│   ├── 概要设计文档.md        # 本文档
│   └── ...
├── oj-common/                 # 公共模块
└── oj-service/                # 服务模块
```

### 12.3 参考文档

- Spring Boot 3.x 官方文档: https://spring.io/projects/spring-boot
- MyBatis-Plus 官方文档: https://baomidou.com/
- go-judge 项目: https://github.com/criyle/go-judge
- JWT 规范: https://jwt.io/
- OpenAPI 3.0 规范: https://swagger.io/specification/

---

## 修订历史

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|----------|--------|
| V1.0 | 2026-01-07 | 初稿完成 | - |
