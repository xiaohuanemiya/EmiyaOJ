# EmiyaOJ 在线判题系统 概要设计文档

## 文档信息

| 项目名称 | EmiyaOJ 在线判题系统 |
|----------|---------------------|
| 文档版本 | V1.0 |
| 创建日期 | 2026年1月6日 |
| 文档类型 | 概要设计文档 |
| 编制人员 | EmiyaOJ开发团队 |

---

## 1. 引言

### 1.1 编写目的

本文档是EmiyaOJ在线判题系统的概要设计文档，旨在从整体架构层面描述系统的设计方案。本文档面向系统架构师、开发工程师、测试工程师和项目管理人员，为系统的详细设计和实现提供指导。

### 1.2 项目背景

随着计算机编程教育的普及和在线学习的快速发展，在线判题系统（Online Judge, OJ）已成为编程学习、算法竞赛和技术面试的重要平台。EmiyaOJ系统致力于打造一个功能完善、安全可靠、性能优异的在线判题平台，为编程学习者和教育机构提供一站式的代码评测服务。

### 1.3 项目范围

EmiyaOJ系统包含以下核心功能模块：
- **用户管理模块**：用户注册、登录、权限管理（基于RBAC模型）
- **在线判题模块**：题目管理、代码提交、自动判题、结果反馈
- **博客社区模块**：技术博客发布、评论、收藏、标签分类
- **系统管理模块**：操作日志、系统监控、数据统计

### 1.4 术语定义

| 术语 | 全称 | 说明 |
|------|------|------|
| OJ | Online Judge | 在线判题系统 |
| RBAC | Role-Based Access Control | 基于角色的访问控制 |
| JWT | JSON Web Token | JSON网络令牌，用于身份认证 |
| AC | Accepted | 代码通过所有测试用例 |
| WA | Wrong Answer | 答案错误 |
| TLE | Time Limit Exceeded | 运行超时 |
| MLE | Memory Limit Exceeded | 内存超限 |
| RE | Runtime Error | 运行时错误 |
| CE | Compile Error | 编译错误 |
| DTO | Data Transfer Object | 数据传输对象 |
| VO | View Object | 视图对象 |
| POJO | Plain Old Java Object | 简单Java对象 |

---

## 2. 总体设计

### 2.1 系统目标

#### 2.1.1 功能目标
- 提供安全、准确、高效的代码自动判题功能
- 支持多种编程语言（C、C++等，可扩展）
- 实现完善的用户和权限管理体系
- 提供友好的用户交互界面
- 建立活跃的技术交流社区

#### 2.1.2 性能目标
- 系统响应时间：普通请求 < 500ms
- 判题响应时间：单个测试用例 < 10s
- 并发支持：支持100+并发用户
- 系统可用性：99%以上

#### 2.1.3 安全目标
- 用户密码加密存储（BCrypt）
- JWT令牌身份认证
- 基于RBAC的细粒度权限控制
- 代码沙箱隔离执行
- SQL注入和XSS攻击防护

### 2.2 技术架构选型

#### 2.2.1 后端技术栈

| 技术组件 | 版本 | 用途说明 |
|---------|------|---------|
| Spring Boot | 3.5.5 | 应用框架，简化配置和部署 |
| Java | 21 | 开发语言，LTS版本 |
| MySQL | 8.0 | 关系型数据库，存储业务数据 |
| MyBatis-Plus | 3.5.13 | ORM框架，简化数据访问 |
| Spring Security | 6.x | 安全框架，认证和授权 |
| Redis | - | 缓存中间件，提升性能 |
| go-judge | - | 判题引擎，代码沙箱执行 |
| Knife4j | - | API文档生成工具 |
| Lombok | - | 代码简化工具 |

#### 2.2.2 前端技术栈

| 技术组件 | 版本 | 用途说明 |
|---------|------|---------|
| Vue.js | 3.5 | 前端框架，渐进式框架 |
| Vite | 5.x | 构建工具，快速开发 |
| TypeScript | 5.x | 开发语言，类型安全 |
| Element Plus | - | UI组件库 |
| Pinia | - | 状态管理 |
| Vue Router | 4.x | 路由管理 |
| Axios | - | HTTP客户端 |
| Monaco Editor | - | 代码编辑器 |

### 2.3 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层 (Client)                      │
├─────────────────────────────────────────────────────────────┤
│  Web浏览器 (Vue 3 + TypeScript + Element Plus)               │
│  - 题目浏览与搜索                                             │
│  - 代码编辑与提交 (Monaco Editor)                             │
│  - 提交记录查看                                               │
│  - 博客发布与浏览                                             │
│  - 用户管理界面                                               │
└─────────────────────────────────────────────────────────────┘
                              ↓ HTTPS/HTTP
┌─────────────────────────────────────────────────────────────┐
│                    表示层 (Presentation)                      │
├─────────────────────────────────────────────────────────────┤
│  Spring MVC Controller                                       │
│  ├─ AuthController          (用户认证)                       │
│  ├─ UserController          (用户管理)                       │
│  ├─ RoleController          (角色管理)                       │
│  ├─ PermissionController    (权限管理)                       │
│  ├─ ProblemController       (题目管理)                       │
│  ├─ TestCaseController      (测试用例管理)                   │
│  ├─ SubmissionController    (代码提交管理)                   │
│  ├─ BlogController          (博客管理)                       │
│  └─ LanguageController      (语言配置管理)                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层 (Business)                      │
├─────────────────────────────────────────────────────────────┤
│  Service接口与实现                                            │
│  ├─ IUserService            (用户服务)                       │
│  ├─ IRoleService            (角色服务)                       │
│  ├─ IPermissionService      (权限服务)                       │
│  ├─ IProblemService         (题目服务)                       │
│  ├─ ITestCaseService        (测试用例服务)                   │
│  ├─ ISubmissionService      (提交服务，异步判题)             │
│  ├─ IBlogService            (博客服务)                       │
│  └─ ILanguageService        (语言服务)                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据访问层 (Data Access)                   │
├─────────────────────────────────────────────────────────────┤
│  MyBatis-Plus Mapper                                         │
│  ├─ UserMapper                                               │
│  ├─ RoleMapper                                               │
│  ├─ PermissionMapper                                         │
│  ├─ ProblemMapper                                            │
│  ├─ TestCaseMapper                                           │
│  ├─ SubmissionMapper                                         │
│  └─ BlogMapper                                               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (Data Storage)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐          ┌──────────────┐                 │
│  │  MySQL 8.0   │          │    Redis     │                 │
│  │  (持久化存储) │          │  (缓存存储)   │                 │
│  └──────────────┘          └──────────────┘                 │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    外部服务 (External)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────┐                   │
│  │  go-judge 判题引擎                    │                   │
│  │  - 代码编译                           │                   │
│  │  - 代码执行                           │                   │
│  │  - 资源限制 (时间/内存)               │                   │
│  │  - 安全沙箱隔离                       │                   │
│  └──────────────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. 系统架构设计

### 3.1 分层架构设计

EmiyaOJ系统采用经典的四层架构模式：

#### 3.1.1 表示层 (Presentation Layer)
- **职责**：处理HTTP请求和响应，参数验证，返回统一格式的JSON数据
- **组件**：Spring MVC Controller
- **特点**：
  - 使用RESTful API设计风格
  - 统一的响应格式封装（ResponseResult）
  - 全局异常处理机制
  - JWT令牌验证

#### 3.1.2 业务逻辑层 (Business Logic Layer)
- **职责**：实现核心业务逻辑，事务管理，业务规则校验
- **组件**：Service接口和实现类
- **特点**：
  - 接口与实现分离
  - 使用@Transactional管理事务
  - 异步任务处理（@Async）
  - 业务异常处理

#### 3.1.3 数据访问层 (Data Access Layer)
- **职责**：数据库操作封装，SQL语句执行
- **组件**：MyBatis-Plus Mapper
- **特点**：
  - 自动生成基础CRUD方法
  - 支持复杂查询的XML映射
  - 分页查询支持
  - 乐观锁和逻辑删除

#### 3.1.4 数据层 (Data Layer)
- **职责**：数据持久化存储
- **组件**：MySQL数据库、Redis缓存
- **特点**：
  - MySQL存储业务数据
  - Redis缓存热点数据
  - 数据库触发器维护统计数据

### 3.2 模块划分

EmiyaOJ系统采用Maven多模块项目结构：

```
EmiyaOJ/
├── pom.xml                    # 父工程POM，统一依赖管理
├── oj-common/                 # 公共模块
│   └── src/main/java/com/emiyaoj/common/
│       ├── config/            # 通用配置（Redis、通用配置）
│       ├── constant/          # 常量定义（JWT、结果枚举）
│       ├── domain/            # 通用领域对象（统一响应）
│       ├── exception/         # 异常类定义
│       ├── handler/           # 全局处理器（异常、认证失败）
│       ├── properties/        # 配置属性（JWT属性）
│       └── utils/             # 工具类（JWT、Redis、对象工具）
└── oj-service/                # 服务模块
    └── src/main/java/com/emiyaoj/service/
        ├── OjApplication.java # 启动类
        ├── config/            # 服务配置（Security、JWT过滤器）
        ├── controller/        # 控制器层（16个Controller）
        ├── domain/            # 领域对象
        │   ├── dto/           # 数据传输对象
        │   ├── pojo/          # 实体类（对应数据库表）
        │   └── vo/            # 视图对象
        ├── mapper/            # 数据访问层（MyBatis Mapper）
        ├── service/           # 服务层接口和实现
        │   └── impl/          # 服务实现类
        └── util/              # 判题工具类
```

#### 模块职责说明

**oj-common模块**：
- 提供通用配置和工具类
- 定义统一的响应格式和异常处理
- 封装JWT认证和Redis缓存工具
- 可被其他模块复用

**oj-service模块**：
- 实现业务功能
- 提供RESTful API接口
- 处理业务逻辑和数据访问
- 集成外部判题引擎

### 3.3 核心功能模块

#### 3.3.1 用户管理模块

**功能概述**：
- 用户注册、登录、登出
- 用户信息管理（增删改查）
- 角色分配和权限管理
- 基于RBAC的访问控制

**核心类**：
- Controller: `AuthController`, `UserController`, `RoleController`, `PermissionController`
- Service: `IUserService`, `IRoleService`, `IPermissionService`
- Entity: `User`, `Role`, `Permission`, `UserRole`, `RolePermission`

**RBAC权限模型**：
```
User (用户) ──N:M──> UserRole ──N:1──> Role (角色)
                                         │
                                       N:M
                                         │
                                         ↓
                            RolePermission ──N:1──> Permission (权限)
```

#### 3.3.2 在线判题模块

**功能概述**：
- 题目管理（增删改查、状态管理）
- 测试用例管理
- 编程语言配置
- 代码提交和异步判题
- 判题结果查询

**核心类**：
- Controller: `ProblemController`, `TestCaseController`, `SubmissionController`, `LanguageController`
- Service: `IProblemService`, `ITestCaseService`, `ISubmissionService`, `ILanguageService`
- Entity: `Problem`, `TestCase`, `Submission`, `SubmissionResult`, `Language`, `Tag`

**判题流程**：
```
1. 用户提交代码
   ↓
2. 创建提交记录 (状态: Pending)
   ↓
3. 异步判题任务启动 (状态: Judging)
   ↓
4. 编译代码（如需要）
   ├─ 编译失败 → Compile Error
   └─ 编译成功 → 获取可执行文件
   ↓
5. 遍历所有测试用例
   ├─ 执行代码
   ├─ 比对输出
   └─ 记录结果
   ↓
6. 更新提交状态
   ├─ Accepted (全部通过)
   ├─ Wrong Answer (输出错误)
   ├─ Time Limit Exceeded (超时)
   ├─ Memory Limit Exceeded (内存超限)
   └─ Runtime Error (运行错误)
   ↓
7. 更新题目统计 (通过数、提交数)
   ↓
8. 清理临时文件
```

#### 3.3.3 博客社区模块

**功能概述**：
- 博客发布、编辑、删除
- 博客评论功能
- 博客收藏功能
- 博客标签分类
- 用户博客统计

**核心类**：
- Controller: `BlogController`, `BlogCommentController`, `BlogStarController`
- Service: `IBlogService`, `IBlogCommentService`, `IBlogStarService`, `IUserBlogService`
- Entity: `Blog`, `BlogComment`, `BlogStar`, `BlogTag`, `UserBlog`

**数据库触发器**：
系统使用数据库触发器自动维护统计数据：
- `after_blog_insert`: 博客发布后增加用户博客计数
- `after_blog_delete`: 博客删除后减少用户博客计数
- `after_blog_star_insert`: 收藏后增加用户收藏计数
- `after_blog_star_delete`: 取消收藏后减少用户收藏计数

#### 3.3.4 系统管理模块

**功能概述**：
- 操作日志记录
- 系统监控
- 数据统计

**核心类**：
- Controller: `OperationLogController`
- Service: `IOperationLogService`
- Entity: `OperationLog`

---

## 4. 数据库设计

### 4.1 数据库概述

- **数据库类型**：MySQL 8.0
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci
- **存储引擎**：InnoDB
- **总表数**：20张表

### 4.2 ER关系图

```
┌──────────────────────────────────────────────────────────────┐
│                        用户权限模块                            │
└──────────────────────────────────────────────────────────────┘
  user ──1:N──> user_role ──N:1──> role ──1:N──> role_permission
                                                      │
                                                    N:1
                                                      │
                                                      ↓
                                                 permission

┌──────────────────────────────────────────────────────────────┐
│                        在线判题模块                            │
└──────────────────────────────────────────────────────────────┘
  problem ──1:N──> test_case
     │
     └──1:N──> problem_tag ──N:1──> tag

  submission ──N:1──> problem
      │       ──N:1──> user
      │       ──N:1──> language
      └──1:N──> submission_result ──N:1──> test_case

  language (编程语言配置表)

┌──────────────────────────────────────────────────────────────┐
│                        博客社区模块                            │
└──────────────────────────────────────────────────────────────┘
  blog ──N:1──> user
    │  ──1:N──> blog_comment ──N:1──> user
    │  ──1:N──> blog_tag_association ──N:1──> blog_tag
    │
    └──1:N──> blog_star ──N:1──> user

  user_blog ──1:1──> user (用户博客统计)
  blog_picture (博客图片管理)

┌──────────────────────────────────────────────────────────────┐
│                        系统管理模块                            │
└──────────────────────────────────────────────────────────────┘
  operation_log (操作日志记录)
```

### 4.3 核心表设计

#### 4.3.1 用户表 (user)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 用户ID |
| username | varchar(50) | UNIQUE, NOT NULL | 用户名 |
| password | varchar(100) | NOT NULL | 密码（加密） |
| nickname | varchar(50) | NULL | 昵称 |
| email | varchar(100) | UNIQUE | 邮箱 |
| phone | varchar(20) | NULL | 手机号 |
| avatar | varchar(255) | NULL | 头像URL |
| status | tinyint | DEFAULT 1 | 状态：0-禁用，1-启用 |
| deleted | tinyint | DEFAULT 0 | 删除标记：0-未删除，1-已删除 |
| create_time | datetime | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引**：
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_username` (`username`)
- UNIQUE KEY: `uk_email` (`email`)
- KEY: `idx_status` (`status`)

#### 4.3.2 角色表 (role)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 角色ID |
| role_code | varchar(50) | UNIQUE, NOT NULL | 角色编码 |
| role_name | varchar(50) | NOT NULL | 角色名称 |
| description | varchar(255) | NULL | 角色描述 |
| status | tinyint | DEFAULT 1 | 状态：0-禁用，1-启用 |
| deleted | tinyint | DEFAULT 0 | 删除标记 |
| create_time | datetime | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

#### 4.3.3 权限表 (permission)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 权限ID |
| parent_id | bigint | DEFAULT 0 | 父权限ID |
| permission_code | varchar(255) | UNIQUE, NOT NULL | 权限编码 |
| permission_name | varchar(50) | NOT NULL | 权限名称 |
| permission_type | tinyint | NOT NULL | 权限类型：1-菜单，2-按钮，3-接口 |
| path | varchar(255) | NULL | 路由路径 |
| component | varchar(255) | NULL | 组件路径 |
| icon | varchar(50) | NULL | 图标 |
| sort_order | int | DEFAULT 0 | 排序 |
| status | tinyint | DEFAULT 1 | 状态：0-禁用，1-启用 |

#### 4.3.4 题目表 (problem)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 题目ID |
| title | varchar(255) | NOT NULL | 题目标题 |
| description | text | NOT NULL | 题目描述 |
| input_description | text | NULL | 输入描述 |
| output_description | text | NULL | 输出描述 |
| sample_input | text | NULL | 样例输入 |
| sample_output | text | NULL | 样例输出 |
| hint | text | NULL | 提示信息 |
| difficulty | tinyint | DEFAULT 1 | 难度：1-简单，2-中等，3-困难 |
| time_limit | int | NOT NULL | CPU时间限制（毫秒） |
| memory_limit | int | NOT NULL | 内存限制（MB） |
| stack_limit | int | DEFAULT 128 | 栈内存限制（MB） |
| source | varchar(255) | NULL | 题目来源 |
| author_id | bigint | NULL | 出题人ID |
| accept_count | int | DEFAULT 0 | 通过次数 |
| submit_count | int | DEFAULT 0 | 提交次数 |
| status | tinyint | DEFAULT 1 | 状态：0-隐藏，1-公开 |
| deleted | tinyint | DEFAULT 0 | 删除标记 |

**索引**：
- PRIMARY KEY: `id`
- KEY: `idx_difficulty` (`difficulty`)
- KEY: `idx_status` (`status`)
- KEY: `idx_author_id` (`author_id`)

#### 4.3.5 测试用例表 (test_case)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 测试用例ID |
| problem_id | bigint | NOT NULL | 题目ID |
| input | longtext | NOT NULL | 输入数据 |
| output | longtext | NOT NULL | 预期输出 |
| is_sample | tinyint | DEFAULT 0 | 是否为样例：0-否，1-是 |
| score | int | DEFAULT 0 | 分值 |
| sort_order | int | DEFAULT 0 | 排序 |
| deleted | tinyint | DEFAULT 0 | 删除标记 |

**索引**：
- PRIMARY KEY: `id`
- KEY: `idx_problem_id` (`problem_id`)
- KEY: `idx_is_sample` (`is_sample`)

#### 4.3.6 提交记录表 (submission)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 提交ID |
| problem_id | bigint | NOT NULL | 题目ID |
| user_id | bigint | NOT NULL | 用户ID |
| language_id | bigint | NOT NULL | 语言ID |
| code | longtext | NOT NULL | 源代码 |
| status | varchar(50) | NOT NULL | 判题状态 |
| score | int | DEFAULT 0 | 得分 |
| time_used | int | DEFAULT 0 | 使用时间（毫秒） |
| memory_used | int | DEFAULT 0 | 使用内存（KB） |
| error_message | text | NULL | 错误信息 |
| compile_message | text | NULL | 编译信息 |
| pass_rate | varchar(50) | NULL | 通过率 |
| ip_address | varchar(50) | NULL | 提交IP |
| create_time | datetime | DEFAULT CURRENT_TIMESTAMP | 提交时间 |

**判题状态枚举**：
- Pending: 等待判题
- Judging: 判题中
- Accepted: 通过
- Wrong Answer: 答案错误
- Time Limit Exceeded: 超时
- Memory Limit Exceeded: 内存超限
- Runtime Error: 运行时错误
- Compile Error: 编译错误
- System Error: 系统错误

#### 4.3.7 编程语言表 (language)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 语言ID |
| name | varchar(50) | NOT NULL | 语言名称 |
| version | varchar(50) | NOT NULL | 版本 |
| compile_command | text | NULL | 编译命令模板 |
| execute_command | text | NOT NULL | 执行命令模板 |
| source_file_ext | varchar(20) | NOT NULL | 源文件扩展名 |
| executable_ext | varchar(20) | NULL | 可执行文件扩展名 |
| is_compiled | tinyint | DEFAULT 1 | 是否需要编译 |
| time_limit_multiplier | decimal(3,2) | DEFAULT 1.00 | 时间限制倍数 |
| memory_limit_multiplier | decimal(3,2) | DEFAULT 1.00 | 内存限制倍数 |
| status | tinyint | DEFAULT 1 | 状态：0-禁用，1-启用 |

**索引**：
- UNIQUE KEY: `uk_name_version` (`name`, `version`)

#### 4.3.8 博客表 (blog)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | bigint | PK, AUTO_INCREMENT | 博客ID |
| user_id | bigint | NOT NULL | 用户ID |
| title | varchar(255) | NOT NULL | 博客标题 |
| content | text | NOT NULL | 博客内容 |
| create_time | datetime | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | DEFAULT CURRENT_TIMESTAMP ON UPDATE | 更新时间 |
| deleted | tinyint | DEFAULT 0 | 删除标记 |

**索引**：
- PRIMARY KEY: `id`
- KEY: `idx_user_id` (`user_id`)
- KEY: `idx_update_time` (`update_time`)

### 4.4 数据库触发器

系统使用数据库触发器自动维护统计数据，避免业务代码中的重复计算：

#### 4.4.1 博客统计触发器

```sql
-- 博客发布后增加计数
CREATE TRIGGER `after_blog_insert` AFTER INSERT ON `blog`
FOR EACH ROW
BEGIN
    UPDATE user_blog SET blog_count = blog_count + 1
    WHERE user_id = NEW.user_id;
END;

-- 博客删除后减少计数
CREATE TRIGGER `after_blog_delete` AFTER UPDATE ON `blog`
FOR EACH ROW
BEGIN
    IF NEW.deleted = 1 AND OLD.deleted = 0 THEN
        UPDATE user_blog SET blog_count = GREATEST(blog_count - 1, 0)
        WHERE user_id = NEW.user_id;
    END IF;
END;
```

#### 4.4.2 收藏统计触发器

```sql
-- 收藏后增加计数
CREATE TRIGGER `after_blog_star_insert` AFTER INSERT ON `blog_star`
FOR EACH ROW
BEGIN
    UPDATE user_blog SET star_count = star_count + 1
    WHERE user_id = NEW.user_id;
END;

-- 取消收藏后减少计数
CREATE TRIGGER `after_blog_star_delete` AFTER DELETE ON `blog_star`
FOR EACH ROW
BEGIN
    UPDATE user_blog SET star_count = GREATEST(star_count - 1, 0)
    WHERE user_id = OLD.user_id;
END;
```

---

## 5. 接口设计

### 5.1 API设计规范

#### 5.1.1 RESTful API风格

系统遵循RESTful API设计原则：
- 使用HTTP方法表示操作：GET（查询）、POST（新增）、PUT（修改）、DELETE（删除）
- 使用资源路径表示实体：/user、/problem、/submission
- 使用HTTP状态码表示结果：200（成功）、400（参数错误）、401（未认证）、403（无权限）、404（未找到）、500（服务器错误）

#### 5.1.2 统一响应格式

**成功响应**：
```json
{
  "code": 200,
  "msg": "Success",
  "data": {
    // 具体数据
  }
}
```

**分页响应**：
```json
{
  "code": 200,
  "msg": "Success",
  "data": {
    "total": 100,
    "pages": 10,
    "current": 1,
    "size": 10,
    "records": [
      // 数据列表
    ]
  }
}
```

**错误响应**：
```json
{
  "code": 400,
  "msg": "参数错误：用户名不能为空",
  "data": null
}
```

### 5.2 核心API接口

#### 5.2.1 认证接口

| 接口路径 | 方法 | 说明 | 权限要求 |
|----------|------|------|----------|
| /auth/login | POST | 用户登录，返回JWT令牌 | 无 |
| /auth/logout | POST | 用户登出，清除会话 | 需认证 |

**登录请求示例**：
```json
{
  "username": "admin",
  "password": "123456"
}
```

**登录响应示例**：
```json
{
  "code": 200,
  "msg": "Success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userId": 1,
    "username": "admin",
    "roles": ["ADMIN"]
  }
}
```

#### 5.2.2 用户管理接口

| 接口路径 | 方法 | 说明 | 权限要求 |
|----------|------|------|----------|
| /user | POST | 创建用户 | ADMIN |
| /user | PUT | 修改用户 | ADMIN |
| /user/page | GET | 分页查询用户 | ADMIN |
| /user/{id} | GET | 获取用户详情 | USER |
| /user/{id} | DELETE | 删除用户 | ADMIN |
| /user/batch | DELETE | 批量删除用户 | ADMIN |
| /user/{id}/status | PUT | 修改用户状态 | ADMIN |
| /user/{id}/reset-password | PUT | 重置密码 | ADMIN |
| /user/{id}/roles | PUT | 分配角色 | ADMIN |

#### 5.2.3 题目管理接口

| 接口路径 | 方法 | 说明 | 权限要求 |
|----------|------|------|----------|
| /problem | POST | 创建题目 | ADMIN |
| /problem | PUT | 修改题目 | ADMIN |
| /problem/page | GET | 分页查询题目 | 无 |
| /problem/{id} | GET | 获取题目详情 | 无 |
| /problem/{id} | DELETE | 删除题目 | ADMIN |
| /problem/batch | DELETE | 批量删除题目 | ADMIN |
| /problem/{id}/status | PUT | 修改题目状态 | ADMIN |

**题目查询响应示例**：
```json
{
  "code": 200,
  "msg": "Success",
  "data": {
    "id": 1,
    "title": "A+B Problem",
    "description": "计算两个整数的和。",
    "difficulty": 1,
    "timeLimit": 1000,
    "memoryLimit": 256,
    "acceptCount": 150,
    "submitCount": 200,
    "tags": ["数学", "入门"]
  }
}
```

#### 5.2.4 代码提交接口

| 接口路径 | 方法 | 说明 | 权限要求 |
|----------|------|------|----------|
| /submission/submit | POST | 提交代码 | USER |
| /submission/page | GET | 分页查询提交记录 | USER |
| /submission/{id} | GET | 获取提交详情 | USER |

**代码提交请求示例**：
```json
{
  "problemId": 1,
  "languageId": 1,
  "code": "#include <stdio.h>\nint main() {\n    int a, b;\n    scanf(\"%d %d\", &a, &b);\n    printf(\"%d\\n\", a + b);\n    return 0;\n}"
}
```

**提交结果响应示例**：
```json
{
  "code": 200,
  "msg": "Success",
  "data": {
    "id": 123,
    "problemId": 1,
    "status": "Accepted",
    "score": 100,
    "timeUsed": 15,
    "memoryUsed": 1024,
    "passRate": "5/5",
    "createTime": "2026-01-06 12:00:00",
    "testResults": [
      {
        "testCaseId": 1,
        "status": "Accepted",
        "timeUsed": 10,
        "memoryUsed": 1024
      }
    ]
  }
}
```

#### 5.2.5 博客接口

| 接口路径 | 方法 | 说明 | 权限要求 |
|----------|------|------|----------|
| /client/blog | POST | 发布博客 | USER |
| /client/blog | GET | 查询所有博客 | 无 |
| /client/blog/query | POST | 分页条件查询 | 无 |
| /client/blog/{id} | GET | 获取博客详情 | 无 |
| /client/blog/{id} | PUT | 修改博客 | USER（本人） |
| /client/blog/{id} | DELETE | 删除博客 | USER（本人） |

---

## 6. 安全设计

### 6.1 认证机制

#### 6.1.1 JWT认证

系统采用JWT（JSON Web Token）进行用户身份认证：

**JWT令牌结构**：
```
Header.Payload.Signature
```

**Payload包含信息**：
- userId: 用户ID
- username: 用户名
- roles: 角色列表
- exp: 过期时间

**认证流程**：
```
1. 用户登录 → 验证用户名密码
   ↓
2. 生成JWT令牌 → 返回给客户端
   ↓
3. 客户端存储令牌 → 每次请求携带令牌（Header: Authorization: Bearer <token>）
   ↓
4. 服务器验证令牌 → JwtTokenOncePerRequestFilter拦截验证
   ↓
5. 解析用户信息 → 存入SecurityContext
   ↓
6. 执行业务逻辑
```

**关键配置**：
- 密钥：由配置文件提供，用于签名和验证
- 过期时间：默认7天
- 令牌前缀：Bearer

#### 6.1.2 密码加密

用户密码使用BCrypt加密算法存储：
- 加盐哈希，防止彩虹表攻击
- 每次加密结果不同，即使相同密码
- 单向加密，无法反向解密

```java
// 密码加密
String encodedPassword = new BCryptPasswordEncoder().encode(rawPassword);

// 密码验证
boolean matches = new BCryptPasswordEncoder().matches(rawPassword, encodedPassword);
```

### 6.2 授权机制

#### 6.2.1 RBAC权限模型

系统采用RBAC（Role-Based Access Control）基于角色的访问控制模型：

**权限层次**：
```
用户 (User)
  ↓ 分配
角色 (Role)
  ↓ 分配
权限 (Permission)
  ├─ 菜单权限 (Menu)
  ├─ 按钮权限 (Button)
  └─ 接口权限 (API)
```

**预定义角色**：
- **ADMIN**（管理员）：拥有所有权限
- **USER**（普通用户）：基本功能权限
- **GUEST**（访客）：只读权限

**权限检查方式**：
```java
// 基于注解的权限检查
@PreAuthorize("hasRole('ADMIN')")
public void adminOnlyMethod() { }

// 基于表达式的权限检查
@PreAuthorize("hasAuthority('user:edit')")
public void editUser() { }
```

#### 6.2.2 Spring Security配置

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())  // 禁用CSRF（使用JWT无需）
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/auth/login", "/auth/register").permitAll()  // 公开接口
                .requestMatchers("/admin/**").hasRole("ADMIN")  // 管理员接口
                .anyRequest().authenticated()  // 其他接口需认证
            )
            .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)  // JWT过滤器
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(authenticationEntryPoint)  // 未认证处理
                .accessDeniedHandler(accessDeniedHandler)  // 无权限处理
            );
        return http.build();
    }
}
```

### 6.3 数据安全

#### 6.3.1 SQL注入防护

使用MyBatis参数绑定防止SQL注入：
```xml
<!-- 安全：使用参数绑定 -->
<select id="findByUsername" resultType="User">
    SELECT * FROM user WHERE username = #{username}
</select>

<!-- 危险：字符串拼接（避免使用） -->
<select id="findByUsername" resultType="User">
    SELECT * FROM user WHERE username = '${username}'
</select>
```

#### 6.3.2 XSS防护

- 前端：对用户输入进行HTML转义
- 后端：使用Spring的HtmlUtils进行转义
- 响应头：设置X-XSS-Protection

#### 6.3.3 敏感信息保护

- 密码：BCrypt加密存储
- 日志：敏感信息脱敏
- 配置：敏感配置加密存储

### 6.4 代码执行安全

#### 6.4.1 沙箱隔离

使用go-judge判题引擎提供的沙箱环境：
- 进程隔离：独立进程空间
- 资源限制：CPU时间、内存、文件大小
- 系统调用限制：禁止危险系统调用
- 文件系统隔离：只读文件系统

#### 6.4.2 资源限制

```java
// 判题配置
JudgeConfig config = JudgeConfig.builder()
    .timeLimit(problem.getTimeLimit())  // 时间限制（毫秒）
    .memoryLimit(problem.getMemoryLimit())  // 内存限制（MB）
    .stackLimit(problem.getStackLimit())  // 栈限制（MB）
    .outputLimit(64 * 1024)  // 输出限制（64KB）
    .build();
```

---

## 7. 性能设计

### 7.1 缓存策略

#### 7.1.1 Redis缓存

**缓存内容**：
- 用户会话信息
- 题目列表（热点数据）
- 权限信息
- 统计数据

**缓存策略**：
```java
// 题目列表缓存
@Cacheable(value = "problems", key = "#page + '_' + #size")
public Page<Problem> listProblems(int page, int size) {
    // 数据库查询
}

// 缓存更新
@CacheEvict(value = "problems", allEntries = true)
public void updateProblem(Problem problem) {
    // 更新逻辑
}
```

**缓存过期策略**：
- 短期数据：5分钟（如统计数据）
- 中期数据：1小时（如题目列表）
- 长期数据：1天（如用户信息）

#### 7.1.2 数据库优化

**索引优化**：
- 为常用查询字段建立索引
- 组合索引优化多条件查询
- 避免过多索引影响写入性能

**查询优化**：
- 使用分页查询，避免一次性加载大量数据
- 使用MyBatis-Plus的条件构造器，避免SQL拼接错误
- 对于复杂查询，使用XML定义SQL

**连接池配置**：
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20  # 最大连接数
      minimum-idle: 5  # 最小空闲连接
      connection-timeout: 30000  # 连接超时（毫秒）
```

### 7.2 异步处理

#### 7.2.1 异步判题

判题过程采用异步处理，避免阻塞用户请求：

```java
@Service
public class SubmissionServiceImpl {
    
    @Async("judgeExecutor")  // 使用自定义线程池
    public CompletableFuture<Void> judgeSubmission(Long submissionId) {
        // 判题逻辑
        // 1. 获取提交信息
        // 2. 编译代码
        // 3. 执行测试用例
        // 4. 更新提交结果
        return CompletableFuture.completedFuture(null);
    }
}
```

**线程池配置**：
```java
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean("judgeExecutor")
    public Executor judgeExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);  // 核心线程数
        executor.setMaxPoolSize(10);  // 最大线程数
        executor.setQueueCapacity(100);  // 队列容量
        executor.setThreadNamePrefix("judge-");
        executor.initialize();
        return executor;
    }
}
```

#### 7.2.2 异步日志记录

操作日志采用异步记录，提升接口响应速度：

```java
@Async("logExecutor")
public void logOperation(OperationLog log) {
    operationLogMapper.insert(log);
}
```

### 7.3 数据库触发器

使用数据库触发器自动维护统计数据，避免业务代码中的重复计算和查询，提升性能。

---

## 8. 部署设计

### 8.1 运行环境

#### 8.1.1 软件环境

| 软件 | 版本 | 说明 |
|------|------|------|
| JDK | 21 | Java运行环境 |
| Maven | 3.8+ | 项目构建工具 |
| MySQL | 8.0 | 关系型数据库 |
| Redis | 6.x+ | 缓存数据库 |
| go-judge | latest | 判题引擎 |
| Nginx | 1.20+ | 反向代理（可选） |

#### 8.1.2 硬件环境

**最小配置**：
- CPU: 2核
- 内存: 4GB
- 磁盘: 20GB

**推荐配置**：
- CPU: 4核+
- 内存: 8GB+
- 磁盘: 50GB+（SSD）

### 8.2 部署架构

```
┌────────────────────────────────────────────────────────────┐
│                        用户浏览器                           │
└────────────────────────────────────────────────────────────┘
                           ↓ HTTPS
┌────────────────────────────────────────────────────────────┐
│                    Nginx反向代理 (可选)                     │
│  - 负载均衡                                                 │
│  - SSL证书                                                  │
│  - 静态资源缓存                                             │
└────────────────────────────────────────────────────────────┘
                           ↓
┌────────────────────────────────────────────────────────────┐
│                    Spring Boot应用                          │
│  - 端口: 8080                                               │
│  - JAR包运行                                                │
│  - JVM参数配置                                              │
└────────────────────────────────────────────────────────────┘
                           ↓
┌──────────────────┐              ┌──────────────────┐
│  MySQL数据库     │              │  Redis缓存       │
│  端口: 3306      │              │  端口: 6379      │
└──────────────────┘              └──────────────────┘
                           ↓
┌────────────────────────────────────────────────────────────┐
│                    go-judge判题引擎                         │
│  - 端口: 5050 (默认)                                        │
│  - 沙箱隔离                                                 │
└────────────────────────────────────────────────────────────┘
```

### 8.3 配置说明

#### 8.3.1 应用配置 (application.yaml)

```yaml
server:
  port: 8080

spring:
  application:
    name: EmiyaOJ
  
  datasource:
    url: jdbc:mysql://localhost:3306/emiya-oj?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  redis:
    host: localhost
    port: 6379
    password: ${REDIS_PASSWORD}
  
  security:
    jwt:
      secret-key: ${JWT_SECRET}
      expiration: 604800000  # 7天

mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

judge:
  go-judge:
    url: http://localhost:5050
```

#### 8.3.2 JVM参数

```bash
java -jar \
  -Xms1g \
  -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -Dspring.profiles.active=prod \
  oj-service.jar
```

### 8.4 数据库初始化

**初始化脚本**：
1. `database/emiya-oj_final.sql` - 完整数据库结构和初始数据
2. `database/rbac_schema.sql` - RBAC权限表结构
3. `database/rbac_init_data.sql` - 权限初始数据

**执行顺序**：
```bash
mysql -u root -p < database/emiya-oj_final.sql
```

---

## 9. 扩展性设计

### 9.1 编程语言扩展

系统支持动态添加新的编程语言，无需修改代码：

**添加步骤**：
1. 在language表中插入新语言配置
2. 配置编译命令和执行命令模板
3. 设置时间和内存限制倍数
4. 测试验证

**示例：添加Python支持**
```sql
INSERT INTO language (name, version, compile_command, execute_command, 
                      source_file_ext, is_compiled, time_limit_multiplier)
VALUES ('Python', '3.11', NULL, 'python3 {source}', '.py', 0, 2.00);
```

### 9.2 判题策略扩展

**支持的扩展**：
- Special Judge：自定义判题逻辑
- Interactive题目：交互式判题
- 部分分机制：按测试用例打分

### 9.3 模块化设计

系统采用Maven多模块结构，便于功能扩展：
- 添加新模块：创建新的Maven子模块
- 模块独立：各模块独立开发和测试
- 依赖管理：通过父POM统一管理依赖版本

---

## 10. 总结

### 10.1 设计特点

1. **分层架构**：清晰的四层架构，职责明确，易于维护
2. **模块化设计**：Maven多模块项目，模块独立，便于扩展
3. **安全可靠**：JWT认证、RBAC授权、沙箱隔离，多层安全保障
4. **性能优异**：Redis缓存、异步处理、数据库优化，提升系统性能
5. **易于扩展**：支持动态添加编程语言，灵活的判题策略

### 10.2 技术亮点

1. **异步判题**：使用@Async实现异步判题，避免阻塞用户请求
2. **数据库触发器**：自动维护统计数据，减少业务代码复杂度
3. **JWT无状态认证**：无需服务器session，支持水平扩展
4. **MyBatis-Plus**：简化数据访问层开发，提供丰富的CRUD操作
5. **统一异常处理**：全局异常处理器，统一返回格式

### 10.3 后续优化方向

1. **性能优化**
   - 引入消息队列处理判题任务
   - 实现判题服务集群和负载均衡
   - 优化数据库查询，添加必要索引

2. **功能扩展**
   - 添加更多编程语言支持（Java、Python、Go等）
   - 实现Special Judge功能
   - 添加比赛模式和排行榜
   - 实现代码相似度检测

3. **用户体验**
   - 优化前端交互
   - 添加实时判题进度推送
   - 提供代码性能分析报告

4. **运维监控**
   - 添加系统监控和告警
   - 实现日志聚合和分析
   - 性能指标采集和可视化

---

## 附录

### A. 数据库表清单

| 序号 | 表名 | 说明 | 行数 |
|------|------|------|------|
| 1 | user | 用户表 | - |
| 2 | role | 角色表 | 3 |
| 3 | permission | 权限表 | 40+ |
| 4 | user_role | 用户角色关联表 | - |
| 5 | role_permission | 角色权限关联表 | 130+ |
| 6 | language | 编程语言表 | 2 |
| 7 | problem | 题目表 | - |
| 8 | tag | 题目标签表 | 16 |
| 9 | problem_tag | 题目标签关联表 | - |
| 10 | test_case | 测试用例表 | - |
| 11 | submission | 提交记录表 | - |
| 12 | submission_result | 判题结果表 | - |
| 13 | blog | 博客表 | - |
| 14 | blog_comment | 博客评论表 | - |
| 15 | blog_star | 博客收藏表 | - |
| 16 | blog_tag | 博客标签表 | - |
| 17 | blog_tag_association | 博客标签关联表 | - |
| 18 | blog_picture | 博客图片表 | - |
| 19 | user_blog | 用户博客统计表 | - |
| 20 | operation_log | 操作日志表 | - |

### B. 接口清单

系统共提供80+个RESTful API接口，分布在以下控制器中：
- AuthController (2个接口)
- UserController (10个接口)
- RoleController (10个接口)
- PermissionController (10个接口)
- ProblemController (7个接口)
- TestCaseController (7个接口)
- SubmissionController (3个接口)
- LanguageController (2个接口)
- BlogController (6个接口)
- 其他客户端接口 (25+个接口)

### C. 参考文档

1. **需求分析文档** (`doc/需求分析文档.md`)
2. **前端设计文档** (`doc/oj-frontend-design.md`)
3. **API文档** (`doc/controller-api-documentation.md`)
4. **数据库脚本** (`database/emiya-oj_final.sql`)

---

**文档版本**: V1.0  
**编制日期**: 2026年1月6日  
**编制人员**: EmiyaOJ开发团队
