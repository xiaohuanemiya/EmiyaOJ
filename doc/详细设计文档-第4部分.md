# EmiyaOJ 在线判题系统 详细设计文档

## 第4部分：博客模块、角色权限模块与系统管理模块详细设计

---

## 6. 博客模块详细设计

### 6.1 模块概述

博客模块为用户提供技术分享和交流平台，支持博客发布、评论、收藏等功能。模块通过数据库触发器自动维护用户博客统计数据。

#### 6.1.1 模块架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    博客模块架构                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Controller层                                                   │
│  ┌──────────────┐  ┌──────────────┐                           │
│  │BlogController│  │ClientBlogCtrl│                            │
│  │（管理端）    │  │（客户端）    │                             │
│  └──────────────┘  └──────────────┘                           │
│         │                  │                                   │
│         ▼                  ▼                                   │
│  ┌────────────────────────────────┐                            │
│  │      IBlogService              │                            │
│  └────────────────────────────────┘                            │
│         │                                                       │
│         ▼                                                       │
│  ┌────────────────────────────────┐                            │
│  │       BlogMapper               │                            │
│  │   BlogCommentMapper            │                            │
│  │     BlogStarMapper             │                            │
│  │     BlogTagMapper              │                            │
│  └────────────────────────────────┘                            │
│         │                                                       │
│         ▼                                                       │
│  ┌────────────────────────────────────────────────────┐        │
│  │              MySQL数据库                            │        │
│  │  blog  blog_comment  blog_star  blog_tag           │        │
│  │  blog_tag_association  blog_picture  user_blog     │        │
│  │                                                    │        │
│  │  ┌──────────────────────────────────────┐         │        │
│  │  │  数据库触发器（自动维护统计数据）      │         │        │
│  │  │  - after_blog_insert                 │         │        │
│  │  │  - after_blog_delete                 │         │        │
│  │  │  - after_blog_star_insert            │         │        │
│  │  │  - after_blog_star_delete            │         │        │
│  │  └──────────────────────────────────────┘         │        │
│  └────────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────────┘
```

#### 6.1.2 数据模型关系

```
┌────────┐         ┌──────┐         ┌──────────────┐
│  user  │────1:N──│ blog │────1:N──│ blog_comment │
└────────┘         └──────┘         └──────────────┘
     │                 │                     │
     │N:M              │N:M                  │N:1
     ▼                 ▼                     ▼
┌───────────┐    ┌─────────────────────┐  ┌────────┐
│ blog_star │    │blog_tag_association │  │  user  │
└───────────┘    └─────────────────────┘  └────────┘
     │                     │
     │N:1                  │N:1
     ▼                     ▼
┌──────┐            ┌───────────┐
│ blog │            │ blog_tag  │
└──────┘            └───────────┘

┌───────────┐  1:1  ┌────────┐
│ user_blog │───────│  user  │  （统计表，触发器维护）
└───────────┘       └────────┘
```

---

### 6.2 博客表设计

#### 6.2.1 博客主表（blog）

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | bigint | - | √ | √ | AUTO_INCREMENT | 博客ID |
| user_id | bigint | - | - | √ | - | 用户ID（作者） |
| title | varchar | 255 | - | √ | - | 博客标题 |
| content | text | - | - | √ | - | 博客内容（支持Markdown） |
| create_time | datetime | - | - | √ | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | √ | CURRENT_TIMESTAMP | 更新时间 |
| deleted | tinyint | - | - | √ | 0 | 删除标记：0-未删除，1-已删除 |

**索引设计**：
```sql
PRIMARY KEY (`id`)
INDEX `idx_user_id` (`user_id`)
INDEX `idx_update_time` (`update_time`)
```

**SQL DDL**：
```sql
CREATE TABLE `blog` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '作者用户ID',
  `title` varchar(255) NOT NULL COMMENT '博客标题',
  `content` text NOT NULL COMMENT '博客内容（Markdown格式）',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` tinyint NOT NULL DEFAULT 0 COMMENT '逻辑删除：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_update_time` (`update_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;
```

#### 6.2.2 实体类设计 (Blog.java)

```java
package com.emiyaoj.service.domain.pojo;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * 博客实体类
 */
@Data
@TableName("blog")
public class Blog implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 博客ID
     */
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;
    
    /**
     * 用户ID（作者）
     */
    private Long userId;
    
    /**
     * 博客标题
     */
    private String title;
    
    /**
     * 博客内容（支持Markdown）
     */
    private String content;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    /**
     * 逻辑删除标记
     */
    @TableLogic
    private Integer deleted;
}
```

#### 6.2.3 博客评论表（blog_comment）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 评论ID |
| blog_id | bigint | 博客ID |
| user_id | bigint | 用户ID（评论者） |
| content | text | 评论内容 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |
| deleted | tinyint | 删除标记 |

**索引**：
```sql
INDEX `idx_blog_id` (`blog_id`)
INDEX `idx_user_id` (`user_id`)
```

#### 6.2.4 博客收藏表（blog_star）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 收藏ID |
| user_id | bigint | 用户ID |
| blog_id | bigint | 博客ID |
| create_time | datetime | 创建时间 |
| deleted | tinyint | 删除标记 |

**唯一约束**：
```sql
UNIQUE INDEX `uk_user_blog` (`user_id`, `blog_id`)
```

**业务说明**：用户-博客组合唯一，一个用户只能收藏同一篇博客一次。

#### 6.2.5 博客标签表（blog_tag）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 标签ID |
| tag | varchar(255) | 标签名称 |
| desc | varchar(255) | 标签描述 |

#### 6.2.6 博客标签关联表（blog_tag_association）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 主键ID |
| blog_id | bigint | 博客ID |
| tag_id | bigint | 标签ID |

**唯一约束**：
```sql
UNIQUE INDEX `uk_blog_tag` (`blog_id`, `tag_id`)
```

#### 6.2.7 用户博客统计表（user_blog）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| user_id | bigint | 用户ID（主键） |
| username | varchar(50) | 用户名 |
| nickname | varchar(50) | 昵称 |
| blog_count | int | 博客数量 |
| star_count | int | 收藏数量 |
| create_time | datetime | 创建时间 |

**数据维护方式**：通过数据库触发器自动维护，不在应用层更新

**触发器设计**：

```sql
-- 1. 博客发布后自动增加blog_count
DROP TRIGGER IF EXISTS `after_blog_insert`;
CREATE TRIGGER `after_blog_insert` AFTER INSERT ON `blog` FOR EACH ROW 
BEGIN
    UPDATE user_blog
    SET blog_count = blog_count + 1
    WHERE user_id = NEW.user_id;
END;

-- 2. 博客删除后自动减少blog_count
DROP TRIGGER IF EXISTS `after_blog_delete`;
CREATE TRIGGER `after_blog_delete` AFTER UPDATE ON `blog` FOR EACH ROW 
BEGIN
    IF NEW.deleted = 1 AND OLD.deleted = 0 THEN
        UPDATE user_blog
        SET blog_count = GREATEST(blog_count - 1, 0)
        WHERE user_id = NEW.user_id;
    END IF;
END;

-- 3. 收藏博客后自动增加star_count
DROP TRIGGER IF EXISTS `after_blog_star_insert`;
CREATE TRIGGER `after_blog_star_insert` AFTER INSERT ON `blog_star` FOR EACH ROW 
BEGIN
    UPDATE user_blog
    SET star_count = star_count + 1
    WHERE user_id = NEW.user_id;
END;

-- 4. 取消收藏后自动减少star_count
DROP TRIGGER IF EXISTS `after_blog_star_delete`;
CREATE TRIGGER `after_blog_star_delete` AFTER DELETE ON `blog_star` FOR EACH ROW 
BEGIN
    UPDATE user_blog
    SET star_count = GREATEST(star_count - 1, 0)
    WHERE user_id = OLD.user_id;
END;

-- 5. 用户名更新同步到user_blog
DROP TRIGGER IF EXISTS `after_user_username_update`;
CREATE TRIGGER `after_user_username_update` AFTER UPDATE ON `user` FOR EACH ROW 
BEGIN
    IF NEW.username <> OLD.username AND NEW.username IS NOT NULL THEN
        UPDATE user_blog
        SET username = NEW.username
        WHERE user_id = NEW.id;
    END IF;
END;

-- 6. 昵称更新同步到user_blog
DROP TRIGGER IF EXISTS `after_user_nickname_update`;
CREATE TRIGGER `after_user_nickname_update` AFTER UPDATE ON `user` FOR EACH ROW 
BEGIN
    IF NEW.nickname <> OLD.nickname AND NEW.nickname IS NOT NULL THEN
        UPDATE user_blog
        SET nickname = NEW.nickname
        WHERE user_id = NEW.id;
    END IF;
END;
```

#### 6.2.8 博客图片表（blog_picture）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| url | varchar(255) | 图片URL（主键） |
| deleted | tinyint | 删除标记 |

**业务说明**：记录博客中上传的图片URL，用于资源管理和清理。

---

### 6.3 博客业务逻辑设计

#### 6.3.1 BlogController API设计

```java
package com.emiyaoj.service.controller;

import com.emiyaoj.common.domain.PageDTO;
import com.emiyaoj.common.domain.PageVO;
import com.emiyaoj.common.domain.ResponseResult;
import com.emiyaoj.service.domain.dto.*;
import com.emiyaoj.service.domain.vo.*;
import com.emiyaoj.service.service.IBlogService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 博客管理控制器（管理端）
 */
@Tag(name = "博客管理", description = "博客管理相关接口")
@RestController
@RequestMapping("/blog")
@RequiredArgsConstructor
public class BlogController {
    
    private final IBlogService blogService;
    
    @Operation(summary = "查询所有博客")
    @GetMapping("")
    @PreAuthorize("hasAuthority('BLOG.LIST')")
    public ResponseResult<List<BlogVO>> blogs() {
        List<BlogVO> vos = blogService.selectAll();
        return ResponseResult.success(vos);
    }
    
    @Operation(summary = "发布博客")
    @PostMapping("")
    @PreAuthorize("hasAuthority('BLOG.ADD')")
    public ResponseResult<Void> addBlog(@RequestBody BlogSaveDTO blogSaveDTO) {
        boolean success = blogService.saveBlog(blogSaveDTO);
        return success ? ResponseResult.success("发布成功") 
                       : ResponseResult.error("发布失败");
    }
    
    @Operation(summary = "分页条件查询博客")
    @PostMapping("/query")
    @PreAuthorize("hasAuthority('BLOG.LIST')")
    public ResponseResult<PageVO<BlogVO>> queryBlog(@RequestBody BlogQueryDTO blogQueryDTO) {
        PageVO<BlogVO> vos = blogService.select(blogQueryDTO);
        return ResponseResult.success(vos);
    }
    
    @Operation(summary = "获取指定博客详情")
    @GetMapping("/{bid}")
    @PreAuthorize("hasAuthority('BLOG.LIST')")
    public ResponseResult<BlogVO> getBlog(@PathVariable Long bid) {
        BlogVO vo = blogService.selectBlogById(bid);
        return vo != null ? ResponseResult.success(vo) 
                          : ResponseResult.error(404, "未找到该博客");
    }
    
    @Operation(summary = "删除博客（逻辑删除）")
    @DeleteMapping("/{bid}")
    @PreAuthorize("hasAuthority('BLOG.DELETE')")
    public ResponseResult<Void> deleteBlog(@PathVariable Long bid) {
        boolean success = blogService.deleteBlogById(bid);
        return success ? ResponseResult.success("删除成功") 
                       : ResponseResult.error("删除失败");
    }
    
    @Operation(summary = "修改博客")
    @PutMapping("/{bid}")
    @PreAuthorize("hasAuthority('BLOG.EDIT')")
    public ResponseResult<Void> editBlog(@PathVariable Long bid, 
                                          @RequestBody BlogEditDTO blogEditDTO) {
        blogEditDTO.setId(bid);
        boolean success = blogService.editBlog(blogEditDTO);
        return success ? ResponseResult.success("修改成功") 
                       : ResponseResult.error("修改失败");
    }
    
    @Operation(summary = "分页查询博客评论")
    @PostMapping("/{bid}/comments/query")
    @PreAuthorize("hasAuthority('COMMENT.LIST')")
    public ResponseResult<PageVO<CommentVO>> selectCommentPage(
            @PathVariable Long bid,
            @RequestBody PageDTO pageDTO) {
        PageVO<CommentVO> vos = blogService.selectCommentPage(bid, pageDTO);
        return vos != null ? ResponseResult.success(vos) 
                           : ResponseResult.error(404, "未找到该博客");
    }
}
```

#### 6.3.2 客户端博客API（ClientBlogController）

```java
package com.emiyaoj.service.controller.client;

import com.emiyaoj.common.domain.ResponseResult;
import com.emiyaoj.service.domain.dto.*;
import com.emiyaoj.service.domain.vo.*;
import com.emiyaoj.service.service.IBlogService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

/**
 * 客户端博客控制器
 * 面向普通用户的博客功能
 */
@Tag(name = "客户端博客", description = "客户端博客相关接口")
@RestController
@RequestMapping("/client/blog")
@RequiredArgsConstructor
public class ClientBlogController {
    
    private final IBlogService blogService;
    
    @Operation(summary = "查询博客列表")
    @GetMapping
    public ResponseResult<List<BlogVO>> blogs() {
        List<BlogVO> vos = blogService.selectAll();
        return ResponseResult.success(vos);
    }
    
    @Operation(summary = "发布博客")
    @PostMapping
    public ResponseResult<Void> addBlog(@RequestBody BlogSaveDTO blogSaveDTO) {
        boolean success = blogService.saveBlog(blogSaveDTO);
        return success ? ResponseResult.success("发布成功") 
                       : ResponseResult.error("发布失败");
    }
    
    @Operation(summary = "条件查询博客")
    @PostMapping("/query")
    public ResponseResult<PageVO<BlogVO>> queryBlog(@RequestBody BlogQueryDTO queryDTO) {
        PageVO<BlogVO> vos = blogService.select(queryDTO);
        return ResponseResult.success(vos);
    }
    
    @Operation(summary = "获取博客详情")
    @GetMapping("/{bid}")
    public ResponseResult<BlogVO> getBlog(@PathVariable Long bid) {
        BlogVO vo = blogService.selectBlogById(bid);
        return vo != null ? ResponseResult.success(vo) 
                          : ResponseResult.error(404, "未找到该博客");
    }
    
    @Operation(summary = "修改博客")
    @PutMapping("/{bid}")
    public ResponseResult<Void> editBlog(@PathVariable Long bid, 
                                          @RequestBody BlogEditDTO editDTO) {
        editDTO.setId(bid);
        boolean success = blogService.editBlog(editDTO);
        return success ? ResponseResult.success("修改成功") 
                       : ResponseResult.error("修改失败");
    }
    
    @Operation(summary = "删除博客")
    @DeleteMapping("/{bid}")
    public ResponseResult<Void> deleteBlog(@PathVariable Long bid) {
        boolean success = blogService.deleteBlogById(bid);
        return success ? ResponseResult.success("删除成功") 
                       : ResponseResult.error("删除失败");
    }
}
```

---

## 7. 角色权限模块详细设计

### 7.1 角色管理（Role）详细设计

#### 7.1.1 角色表设计

**表名**：`role`

| 字段名 | 数据类型 | 长度 | 说明 |
|--------|---------|------|------|
| id | bigint | - | 角色ID |
| role_code | varchar | 50 | 角色编码（唯一） |
| role_name | varchar | 50 | 角色名称 |
| description | varchar | 255 | 角色描述 |
| status | tinyint | - | 状态：0-禁用，1-启用 |
| deleted | tinyint | - | 删除标记 |
| create_time | datetime | - | 创建时间 |
| update_time | datetime | - | 更新时间 |
| create_by | bigint | - | 创建者 |
| update_by | bigint | - | 更新者 |

**索引**：
```sql
PRIMARY KEY (`id`)
UNIQUE KEY `uk_role_code` (`role_code`)
INDEX `idx_status` (`status`)
```

**SQL DDL**：
```sql
CREATE TABLE `role` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '角色ID',
  `role_code` varchar(50) NOT NULL COMMENT '角色编码',
  `role_name` varchar(50) NOT NULL COMMENT '角色名称',
  `description` varchar(255) DEFAULT NULL COMMENT '角色描述',
  `status` tinyint DEFAULT '1' COMMENT '状态：0-禁用，1-启用',
  `deleted` tinyint DEFAULT '0' COMMENT '删除标记',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `create_by` bigint DEFAULT NULL,
  `update_by` bigint DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_role_code` (`role_code`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='角色表';
```

**预置角色数据**：
```sql
INSERT INTO `role` VALUES 
  (1, 'ADMIN', '系统管理员', '拥有所有权限', 1, 0, NOW(), NOW(), NULL, NULL),
  (2, 'USER', '普通用户', '基础用户权限', 1, 0, NOW(), NOW(), NULL, NULL),
  (3, 'GUEST', '访客', '只读权限', 1, 0, NOW(), NOW(), NULL, NULL);
```

#### 7.1.2 实体类设计 (Role.java)

```java
package com.emiyaoj.service.domain.pojo;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * 角色实体类
 */
@Data
@TableName("role")
public class Role implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 角色ID
     */
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;
    
    /**
     * 角色编码（如ADMIN, USER）
     */
    private String roleCode;
    
    /**
     * 角色名称
     */
    private String roleName;
    
    /**
     * 角色描述
     */
    private String description;
    
    /**
     * 状态：0-禁用，1-启用
     */
    private Integer status;
    
    /**
     * 逻辑删除
     */
    @TableLogic
    private Integer deleted;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
    
    /**
     * 创建者
     */
    private Long createBy;
    
    /**
     * 更新者
     */
    private Long updateBy;
}
```

#### 7.1.3 RoleController API设计

```java
package com.emiyaoj.service.controller;

import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.emiyaoj.common.domain.ResponseResult;
import com.emiyaoj.service.domain.dto.RoleQueryDTO;
import com.emiyaoj.service.domain.dto.RoleSaveDTO;
import com.emiyaoj.service.domain.vo.RoleVO;
import com.emiyaoj.service.service.IRoleService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 角色管理控制器
 */
@Tag(name = "角色管理", description = "角色管理相关接口")
@RestController
@RequestMapping("/role")
@RequiredArgsConstructor
public class RoleController {
    
    private final IRoleService roleService;
    
    @Operation(summary = "分页查询角色列表")
    @GetMapping("/page")
    @PreAuthorize("hasAuthority('ROLE.LIST')")
    public ResponseResult<Page<RoleVO>> getRolePage(@Valid RoleQueryDTO queryDTO) {
        Page<RoleVO> page = roleService.selectRolePage(queryDTO);
        return ResponseResult.success(page);
    }
    
    @Operation(summary = "查询所有角色")
    @GetMapping("/list")
    @PreAuthorize("hasAuthority('ROLE.LIST')")
    public ResponseResult<List<RoleVO>> getAllRoles() {
        List<RoleVO> roles = roleService.selectAllRoles();
        return ResponseResult.success(roles);
    }
    
    @Operation(summary = "根据ID查询角色")
    @GetMapping("/{id}")
    @PreAuthorize("hasAuthority('ROLE.LIST')")
    public ResponseResult<RoleVO> getRoleById(@PathVariable Long id) {
        RoleVO roleVO = roleService.selectRoleById(id);
        return ResponseResult.success(roleVO);
    }
    
    @Operation(summary = "新增角色")
    @PostMapping
    @PreAuthorize("hasAuthority('ROLE.ADD')")
    public ResponseResult<Void> saveRole(@Valid @RequestBody RoleSaveDTO saveDTO) {
        boolean result = roleService.saveRole(saveDTO);
        return result ? ResponseResult.success("新增成功") 
                      : ResponseResult.error("新增失败");
    }
    
    @Operation(summary = "修改角色")
    @PutMapping
    @PreAuthorize("hasAuthority('ROLE.EDIT')")
    public ResponseResult<Void> updateRole(@Valid @RequestBody RoleSaveDTO saveDTO) {
        boolean result = roleService.updateRole(saveDTO);
        return result ? ResponseResult.success("修改成功") 
                      : ResponseResult.error("修改失败");
    }
    
    @Operation(summary = "删除角色")
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('ROLE.DELETE')")
    public ResponseResult<Void> deleteRole(@PathVariable Long id) {
        boolean result = roleService.deleteRole(id);
        return result ? ResponseResult.success("删除成功") 
                      : ResponseResult.error("删除失败");
    }
    
    @Operation(summary = "为角色分配权限")
    @PutMapping("/{id}/permissions")
    @PreAuthorize("hasAuthority('ROLE.ASSIGN.PERMISSION')")
    public ResponseResult<Void> assignPermissions(
            @PathVariable Long id,
            @RequestBody List<Long> permissionIds) {
        boolean result = roleService.assignPermissions(id, permissionIds);
        return result ? ResponseResult.success("分配权限成功") 
                      : ResponseResult.error("分配权限失败");
    }
}
```

---

### 7.2 权限管理（Permission）详细设计

#### 7.2.1 权限表设计

**表名**：`permission`

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 权限ID |
| parent_id | bigint | 父权限ID（树形结构） |
| permission_code | varchar(255) | 权限编码（唯一） |
| permission_name | varchar(50) | 权限名称 |
| permission_type | tinyint | 权限类型：1-菜单，2-按钮，3-接口 |
| path | varchar(255) | 路由路径 |
| component | varchar(255) | 组件路径 |
| icon | varchar(50) | 图标 |
| sort_order | int | 排序 |
| status | tinyint | 状态：0-禁用，1-启用 |
| deleted | tinyint | 删除标记 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

**权限类型说明**：
- **1-菜单**：前端菜单项，如"用户管理"、"题目管理"
- **2-按钮**：页面操作按钮，如"新增"、"编辑"、"删除"
- **3-接口**：后端API接口权限，通过`@PreAuthorize`注解控制

**权限树示例**：
```
系统管理（菜单）
├── 用户管理（菜单）
│   ├── 查看用户（按钮）USER.LIST
│   ├── 新增用户（按钮）USER.ADD
│   ├── 编辑用户（按钮）USER.EDIT
│   └── 删除用户（按钮）USER.DELETE
├── 角色管理（菜单）
│   ├── 查看角色（按钮）ROLE.LIST
│   ├── 新增角色（按钮）ROLE.ADD
│   └── 分配权限（按钮）ROLE.ASSIGN.PERMISSION
└── 权限管理（菜单）
    ├── 查看权限（按钮）PERMISSION.LIST
    └── 编辑权限（按钮）PERMISSION.EDIT
```

#### 7.2.2 权限编码规范

权限编码采用**资源.操作**的命名规范：

| 权限编码 | 说明 | 类型 |
|---------|------|------|
| USER.LIST | 查看用户列表 | 接口 |
| USER.ADD | 新增用户 | 接口 |
| USER.EDIT | 编辑用户 | 接口 |
| USER.DELETE | 删除用户 | 接口 |
| USER.RESET.PASSWORD | 重置密码 | 接口 |
| USER.ASSIGN.ROLE | 分配角色 | 接口 |
| ROLE.LIST | 查看角色 | 接口 |
| ROLE.ADD | 新增角色 | 接口 |
| ROLE.EDIT | 编辑角色 | 接口 |
| ROLE.DELETE | 删除角色 | 接口 |
| ROLE.ASSIGN.PERMISSION | 分配权限 | 接口 |
| PROBLEM.LIST | 查看题目 | 接口 |
| PROBLEM.ADD | 新增题目 | 接口 |
| PROBLEM.EDIT | 编辑题目 | 接口 |
| PROBLEM.DELETE | 删除题目 | 接口 |
| BLOG.LIST | 查看博客 | 接口 |
| BLOG.ADD | 发布博客 | 接口 |
| BLOG.EDIT | 编辑博客 | 接口 |
| BLOG.DELETE | 删除博客 | 接口 |

---

### 7.3 用户-角色-权限关联表设计

#### 7.3.1 用户角色关联表（user_role）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 主键ID |
| user_id | bigint | 用户ID |
| role_id | bigint | 角色ID |
| create_time | datetime | 创建时间 |
| create_by | bigint | 创建者 |

**唯一约束**：
```sql
UNIQUE INDEX `uk_user_role` (`user_id`, `role_id`)
```

**外键约束**：
```sql
FOREIGN KEY (`user_id`) REFERENCES `user` (`id`) ON DELETE CASCADE
FOREIGN KEY (`role_id`) REFERENCES `role` (`id`) ON DELETE CASCADE
```

#### 7.3.2 角色权限关联表（role_permission）

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 主键ID |
| role_id | bigint | 角色ID |
| permission_id | bigint | 权限ID |
| create_time | datetime | 创建时间 |
| create_by | bigint | 创建者 |

**唯一约束**：
```sql
UNIQUE INDEX `uk_role_permission` (`role_id`, `permission_id`)
```

**外键约束**：
```sql
FOREIGN KEY (`role_id`) REFERENCES `role` (`id`) ON DELETE CASCADE
FOREIGN KEY (`permission_id`) REFERENCES `permission` (`id`) ON DELETE CASCADE
```

---

## 8. 系统管理模块详细设计

### 8.1 操作日志（OperationLog）详细设计

#### 8.1.1 操作日志表设计

**表名**：`operation_log`

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 日志ID |
| title | varchar(50) | 模块标题 |
| business_type | tinyint | 业务类型（见枚举） |
| method | varchar(100) | 方法名称 |
| request_method | varchar(10) | 请求方式（GET/POST等） |
| operator_type | tinyint | 操作类别：0-其它，1-后台，2-手机端 |
| oper_name | varchar(50) | 操作人员 |
| oper_url | varchar(255) | 请求URL |
| oper_ip | varchar(50) | 主机地址 |
| oper_location | varchar(255) | 操作地点 |
| oper_param | text | 请求参数 |
| json_result | text | 返回参数 |
| status | tinyint | 操作状态：0-正常，1-异常 |
| error_msg | varchar(2000) | 错误消息 |
| oper_time | datetime | 操作时间 |

**业务类型枚举**：
- 1-新增
- 2-修改
- 3-删除
- 4-授权
- 5-导出
- 6-导入
- 7-强退
- 8-生成代码
- 9-清空数据

**索引设计**：
```sql
INDEX `idx_title` (`title`)
INDEX `idx_business_type` (`business_type`)
INDEX `idx_status` (`status`)
INDEX `idx_oper_time` (`oper_time`)
```

---

## 第4部分总结

本部分完成了以下模块的详细设计：

1. **博客模块**：
   - Blog、BlogComment、BlogStar等7张表设计
   - 数据库触发器自动维护统计数据
   - BlogController和ClientBlogController API设计
   
2. **角色权限模块**：
   - Role角色表设计
   - Permission权限表设计（树形结构、权限编码规范）
   - user_role、role_permission关联表设计
   - RBAC权限模型实现
   
3. **系统管理模块**：
   - OperationLog操作日志表设计
   - 业务类型枚举和索引设计

**下一部分预告：第5部分 - 安全设计、性能优化与部署设计**

将包含：
- Spring Security详细配置
- JWT认证实现细节
- Redis缓存设计
- 性能优化策略
- 部署架构设计

---

*EmiyaOJ详细设计文档 - 第4部分结束*
