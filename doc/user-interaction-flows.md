# EmiyaOJ 用户端交互流程文档

## 1. 用户认证流程

### 1.1 登录流程

```
┌─────────────┐
│ 用户访问首页 │
└──────┬──────┘
       ↓
┌─────────────────┐
│ 检查本地 Token   │
└──────┬──────────┘
       ↓
   ┌───┴───┐
   │Token? │
   └───┬───┘
       │
   是──┼──否
       │       ↓
       │   ┌────────────┐
       │   │跳转登录页面│
       │   └─────┬──────┘
       │         ↓
       │   ┌────────────┐
       │   │输入用户名密码│
       │   └─────┬──────┘
       │         ↓
       │   ┌────────────┐
       │   │提交登录请求 │
       │   └─────┬──────┘
       │         ↓
       │    ┌───┴───┐
       │    │验证？ │
       │    └───┬───┘
       │        │
       │    成功─┼─失败
       │        │     ↓
       │        │  ┌──────────┐
       │        │  │显示错误  │
       │        │  │重新输入  │
       │        │  └──────────┘
       │        ↓
       │   ┌────────────┐
       │   │保存 Token  │
       │   │更新用户状态│
       │   └─────┬──────┘
       ↓         ↓
   ┌─────────────────┐
   │   进入首页      │
   └─────────────────┘
```

### 1.2 自动登录流程

- **本地存储**: Token 存储在 localStorage
- **Token 验证**: 每次应用启动时验证 Token 有效性
- **自动刷新**: Token 过期前自动刷新（可选）
- **登出清理**: 登出时清除所有本地数据

### 1.3 权限控制

```typescript
// 路由守卫示例
router.beforeEach((to, from, next) => {
  const userStore = useUserStore()
  
  if (to.meta.requiresAuth && !userStore.isLoggedIn) {
    // 需要登录但未登录，跳转到登录页
    next({
      name: 'Login',
      query: { redirect: to.fullPath }
    })
  } else {
    next()
  }
})
```

## 2. 题目浏览流程

### 2.1 题目列表浏览

```
┌──────────────┐
│进入题目列表页 │
└──────┬───────┘
       ↓
┌──────────────┐
│ 加载题目列表  │
│ (分页加载)   │
└──────┬───────┘
       ↓
┌──────────────────┐
│ 显示题目卡片     │
│ - 题目ID        │
│ - 标题          │
│ - 难度          │
│ - 通过率        │
│ - 标签          │
│ - 个人状态      │
└──────┬───────────┘
       ↓
┌──────────────────┐
│ 用户交互选项：    │
│ 1. 筛选（难度）   │
│ 2. 搜索（关键词） │
│ 3. 排序          │
│ 4. 切换页码      │
│ 5. 点击题目      │
└──────┬───────────┘
       ↓
┌──────────────┐
│ 进入题目详情  │
└──────────────┘
```

### 2.2 题目搜索与筛选

**筛选条件：**
- **难度**: 简单 / 中等 / 困难
- **状态**: 未尝试 / 尝试过 / 已通过
- **关键词**: 题目ID或标题

**交互方式：**
1. 选择筛选条件
2. 自动触发搜索
3. 实时更新列表
4. 重置为第一页

**前端实现：**
```typescript
const filters = reactive({
  difficulty: undefined,
  status: undefined,
  keyword: ''
})

// 监听筛选条件变化
watch(filters, () => {
  pagination.current = 1
  fetchProblems()
}, { deep: true })
```

### 2.3 题目卡片交互

**鼠标悬停效果：**
- 卡片阴影加深
- 轻微上移动画
- 显示更多信息（可选）

**点击跳转：**
- 整个卡片可点击
- 跳转到题目详情页
- 保留筛选状态（通过 query 参数）

## 3. 题目详情与代码提交流程

### 3.1 题目详情页布局

```
┌─────────────────────────────────────────┐
│ 题目详情页                               │
│                                         │
│ ┌────────────────┐  ┌────────────────┐ │
│ │ 左侧：题目信息  │  │ 右侧：代码编辑器│ │
│ │                │  │                │ │
│ │ - 题目描述     │  │ - 语言选择     │ │
│ │ - 输入格式     │  │ - 代码编辑     │ │
│ │ - 输出格式     │  │ - 提交按钮     │ │
│ │ - 样例输入输出 │  │                │ │
│ │ - 时间/内存限制│  │ - 最近提交记录 │ │
│ │ - 标签         │  │                │ │
│ └────────────────┘  └────────────────┘ │
└─────────────────────────────────────────┘
```

### 3.2 代码编辑与提交流程

```
┌──────────────┐
│ 查看题目描述  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 选择编程语言  │
│ (C/C++/Java) │
└──────┬───────┘
       ↓
┌──────────────┐
│ 编写代码     │
│ (Monaco编辑器)│
└──────┬───────┘
       ↓
┌──────────────┐
│ 点击提交按钮  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 前端验证     │
│ - 代码非空   │
│ - 语言已选择 │
└──────┬───────┘
       ↓
   ┌───┴───┐
   │验证？ │
   └───┬───┘
       │
   通过─┼─不通过
       │        ↓
       │   ┌──────────┐
       │   │显示提示  │
       │   └────┬─────┘
       │        ↓
       │   ┌──────────┐
       │   │返回编辑  │
       │   └──────────┘
       ↓
┌──────────────┐
│ 发送提交请求  │
│ POST /submit │
└──────┬───────┘
       ↓
┌──────────────┐
│ 后端创建提交  │
│ 返回提交ID   │
└──────┬───────┘
       ↓
┌──────────────┐
│ 显示提交成功  │
│ 跳转详情页   │
└──────────────┘
```

### 3.3 代码编辑器功能

**基础功能：**
- 语法高亮
- 代码补全
- 括号匹配
- 代码折叠
- 行号显示

**快捷键：**
- `Ctrl/Cmd + S`: 提交代码
- `Ctrl/Cmd + /`: 注释
- `Tab`: 缩进
- `Shift + Tab`: 反缩进
- `Ctrl/Cmd + Z`: 撤销
- `Ctrl/Cmd + Y`: 重做

**代码模板：**
```cpp
// C++ 模板
#include <iostream>
using namespace std;

int main() {
    // Your code here
    return 0;
}
```

## 4. 判题结果查看流程

### 4.1 提交详情页实时更新

```
┌──────────────┐
│ 进入提交详情页│
└──────┬───────┘
       ↓
┌──────────────┐
│ 获取提交信息  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 检查判题状态  │
└──────┬───────┘
       ↓
   ┌───┴───────┐
   │判题完成？  │
   └───┬───────┘
       │
   否──┼──是
       │       ↓
       │   ┌────────────┐
       │   │显示最终结果│
       │   └────────────┘
       ↓
┌──────────────────┐
│ 显示"判题中"     │
│ 开始轮询        │
│ (每2秒请求一次)  │
└──────┬───────────┘
       ↓
┌──────────────────┐
│ 更新判题状态     │
│ - Pending → Judging │
│ - Judging → Result  │
└──────┬───────────┘
       ↓
┌──────────────────┐
│ 判题完成         │
│ - 停止轮询       │
│ - 显示结果通知   │
│ - 展示详细信息   │
└──────────────────┘
```

### 4.2 轮询机制实现

```typescript
// 使用组合式函数实现轮询
const { start, stop } = usePolling(
  // 请求函数
  () => getSubmissionDetail(id),
  // 继续条件：status 为 0(Pending) 或 7(Judging)
  () => submission.value?.status === 0 || 
        submission.value?.status === 7,
  // 轮询间隔：2秒
  2000
)

// 组件挂载时开始轮询
onMounted(() => {
  if (isJudging.value) {
    start()
  }
})

// 组件卸载时停止轮询
onUnmounted(() => {
  stop()
})
```

### 4.3 判题结果展示

**状态标签：**
```
┌─────────────────────────────────────┐
│ 提交状态                             │
│                                     │
│ ✓ 通过 (绿色)                        │
│ ✗ 答案错误 (红色)                    │
│ ⚠ 编译错误 (黄色)                    │
│ ⏱ 超时 (黄色)                        │
│ 💾 内存超限 (黄色)                   │
│ ⚡ 运行时错误 (红色)                  │
│ ⏳ 判题中 (蓝色)                     │
└─────────────────────────────────────┘
```

**详细信息：**
- 运行时间 (ms)
- 内存使用 (KB)
- 判题信息 (JSON 格式化显示)
- 提交代码 (只读模式)
- 测试用例结果 (如果可见)

## 5. 提交记录管理流程

### 5.1 提交记录列表

```
┌──────────────────┐
│ 进入提交记录页    │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 加载提交列表      │
│ (分页)           │
└────────┬─────────┘
         ↓
┌─────────────────────────────┐
│ 显示提交记录表格             │
│ ┌─────┬──────┬──────┬─────┐│
│ │ID   │题目  │状态  │时间 ││
│ ├─────┼──────┼──────┼─────┤│
│ │1001 │A+B   │通过  │100ms││
│ │1002 │排序  │错误  │-    ││
│ └─────┴──────┴──────┴─────┘│
└────────┬────────────────────┘
         ↓
┌──────────────────┐
│ 用户操作：        │
│ - 按题目筛选      │
│ - 按状态筛选      │
│ - 查看详情        │
│ - 重新提交        │
└──────────────────┘
```

### 5.2 筛选功能

**筛选选项：**
1. **按题目**: 下拉选择题目
2. **按状态**: 选择判题状态
3. **按时间**: 日期范围选择（可选）

**交互方式：**
- 筛选条件联动
- 实时更新列表
- 保留分页状态
- URL 参数同步

### 5.3 提交对比（未来功能）

```
┌──────────────────┐
│ 选择两个提交      │
└────────┬─────────┘
         ↓
┌──────────────────┐
│ 对比视图          │
│ ┌──────┬──────┐  │
│ │提交A │提交B │  │
│ ├──────┼──────┤  │
│ │代码  │代码  │  │
│ │结果  │结果  │  │
│ └──────┴──────┘  │
└──────────────────┘
```

## 6. 错误处理流程

### 6.1 网络错误

```
┌──────────────┐
│ API 请求失败  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 显示错误提示  │
│ (Toast/Message)│
└──────┬───────┘
       ↓
┌──────────────┐
│ 提供重试选项  │
└──────────────┘
```

### 6.2 表单验证错误

```
┌──────────────┐
│ 用户提交表单  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 前端验证     │
└──────┬───────┘
       ↓
   ┌───┴───┐
   │通过？ │
   └───┬───┘
       │
   否──┼──是
       │       ↓
       │   ┌──────────┐
       │   │提交请求  │
       │   └──────────┘
       ↓
┌──────────────┐
│ 显示错误提示  │
│ 高亮错误字段  │
└──────┬───────┘
       ↓
┌──────────────┐
│ 用户修正输入  │
└──────────────┘
```

### 6.3 权限错误

```
┌──────────────┐
│ 401 未授权   │
└──────┬───────┘
       ↓
┌──────────────┐
│ 清除本地Token │
└──────┬───────┘
       ↓
┌──────────────┐
│ 跳转登录页    │
└──────────────┘
```

## 7. 用户体验优化

### 7.1 加载状态

**骨架屏：**
- 题目列表加载
- 题目详情加载
- 提交记录加载

**加载动画：**
- 全屏 Loading
- 按钮 Loading
- 局部 Loading

**进度提示：**
- 判题进度
- 上传进度
- 操作进度

### 7.2 响应式设计

**断点：**
- 手机: < 768px
- 平板: 768px - 1024px
- 桌面: > 1024px

**适配策略：**
```
桌面端：
┌─────────────┬─────────────┐
│ 题目描述 50% │ 代码编辑 50%│
└─────────────┴─────────────┘

移动端：
┌─────────────┐
│ 题目描述     │
├─────────────┤
│ 代码编辑     │
└─────────────┘
```

### 7.3 缓存策略

**本地缓存：**
- 用户信息
- 语言列表
- 代码草稿

**会话缓存：**
- 题目列表
- 筛选条件
- 滚动位置

**缓存过期：**
- Token: 7天
- 题目列表: 5分钟
- 语言列表: 1小时

## 8. 性能优化

### 8.1 懒加载

- 路由懒加载
- 组件懒加载
- 图片懒加载
- Monaco Editor 延迟初始化

### 8.2 防抖与节流

```typescript
// 搜索防抖
const debouncedSearch = debounce(fetchProblems, 500)

// 滚动节流
const throttledScroll = throttle(handleScroll, 200)
```

### 8.3 虚拟滚动

对于大量数据的列表使用虚拟滚动：
- 提交记录列表
- 题目列表（可选）

## 9. 辅助功能

### 9.1 快捷键

| 快捷键 | 功能 |
|--------|------|
| `Ctrl/Cmd + K` | 打开搜索 |
| `Ctrl/Cmd + S` | 提交代码 |
| `Esc` | 关闭模态框 |
| `?` | 显示快捷键帮助 |

### 9.2 主题切换

- 亮色主题
- 暗色主题
- 跟随系统

### 9.3 国际化支持（未来）

- 中文
- 英文
- 其他语言

## 10. 总结

本文档详细描述了 EmiyaOJ 用户端的各种交互流程，包括：

1. **认证流程**: 登录、权限控制
2. **题目浏览**: 列表、搜索、筛选
3. **代码提交**: 编辑、提交、验证
4. **判题查看**: 实时更新、结果展示
5. **记录管理**: 查询、筛选、对比
6. **错误处理**: 网络、表单、权限
7. **用户体验**: 加载、响应式、缓存
8. **性能优化**: 懒加载、防抖、虚拟滚动
9. **辅助功能**: 快捷键、主题、国际化

这些流程确保了用户在使用 OJ 系统时能够获得流畅、高效的体验。
