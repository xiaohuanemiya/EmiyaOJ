# EmiyaOJ 在线判题系统 详细设计文档

## 第3部分：在线判题模块详细设计

---

## 5. 在线判题模块详细设计

### 5.1 模块概述

在线判题模块是EmiyaOJ系统的核心功能模块，负责题目管理、代码提交、自动判题等功能。模块采用异步判题机制，集成go-judge沙箱引擎，确保代码执行的安全性和隔离性。

#### 5.1.1 模块架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    在线判题模块架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  表现层（Controller）                                            │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────────┐      │
│  │ProblemCtrl  │  │TestCaseCtrl  │  │SubmissionCtrl    │      │
│  └─────────────┘  └──────────────┘  └──────────────────┘      │
│         │                │                    │                │
│         ▼                ▼                    ▼                │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────────┐      │
│  │ProblemSvc   │  │TestCaseSvc   │  │SubmissionSvc     │      │
│  └─────────────┘  └──────────────┘  └──────────────────┘      │
│         │                │                    │                │
│         │                │                    │                │
│         │                │                    └───────┐        │
│         ▼                ▼                            ▼        │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ProblemMap   │  │TestCaseMap   │  │  GoJudgeService      │  │
│  └─────────────┘  └──────────────┘  │  （判题引擎服务）     │  │
│         │                │           └──────────────────────┘  │
│         ▼                ▼                    │                │
│  ┌───────────────────────────┐              ▼                │
│  │        MySQL数据库         │    ┌─────────────────┐        │
│  │  problem   test_case      │    │   go-judge      │        │
│  │  submission submission_    │    │   判题沙箱       │        │
│  │  result    language        │    └─────────────────┘        │
│  └───────────────────────────┘                                │
└─────────────────────────────────────────────────────────────────┘
```

#### 5.1.2 判题流程设计

```
┌────────┐    提交代码    ┌──────────────┐    创建提交记录    ┌──────────┐
│ 客户端 │──────────────→│ Submission   │──────────────────→│  MySQL  │
└────────┘                │ Controller   │                    └──────────┘
                          └──────────────┘                          │
                                 │                                  │
                                 │ 调用Service                       │
                                 ▼                                  │
                          ┌──────────────┐                          │
                          │ Submission   │                          │
                          │   Service    │                          │
                          └──────────────┘                          │
                                 │                                  │
                    ┌────────────┴──────────────┐                  │
                    │                           │                  │
                    ▼                           ▼                  │
           ┌─────────────────┐       ┌─────────────────┐          │
           │  1. 参数校验     │       │  2. 保存提交记录 │◄─────────┘
           │  - 题目存在      │       │     status=Pending│
           │  - 语言支持      │       └─────────────────┘
           │  - 代码合法      │                │
           └─────────────────┘                │
                                              │
                                              ▼
                                   ┌────────────────────┐
                                   │ 3. 异步执行判题     │
                                   │   @Async注解       │
                                   │   独立线程池        │
                                   └────────────────────┘
                                              │
                        ┌─────────────────────┴─────────────────────┐
                        │                                           │
                        ▼                                           ▼
              ┌──────────────────┐                       ┌──────────────────┐
              │ 4. 编译代码       │                       │ 5. 查询测试用例   │
              │  (如需要)         │                       │   - problem_id   │
              │  调用go-judge     │                       │   - is_sample=0  │
              └──────────────────┘                       └──────────────────┘
                        │                                           │
                        │ 编译失败                                   │
                        ├──→ 返回Compile Error                       │
                        │                                           │
                        │ 编译成功                                   │
                        └──────────────┬────────────────────────────┘
                                      │
                                      ▼
                             ┌─────────────────────┐
                             │ 6. 依次执行测试用例  │
                             │   for each test_case│
                             └─────────────────────┘
                                      │
                        ┌─────────────┴─────────────┐
                        │                           │
                        ▼                           ▼
              ┌──────────────────┐       ┌──────────────────┐
              │ 7. 调用go-judge  │       │ 8. 比较输出       │
              │  - 输入数据       │       │   - 预期输出      │
              │  - 时间限制       │──────→│   - 实际输出      │
              │  - 内存限制       │       │   - 去除空白      │
              └──────────────────┘       └──────────────────┘
                                                    │
                        ┌───────────────────────────┴───────────────────┐
                        │                                               │
                        ▼                                               ▼
              ┌──────────────────┐                           ┌──────────────────┐
              │ Wrong Answer     │                           │ Accepted         │
              │ Time Exceeded    │                           │ 继续下一个用例     │
              │ Memory Exceeded  │                           └──────────────────┘
              │ Runtime Error    │
              │ 终止判题         │
              └──────────────────┘
                        │
                        └───────────────┬───────────────────────────────┘
                                       │
                                       ▼
                            ┌────────────────────┐
                            │ 9. 更新提交记录     │
                            │  - status          │
                            │  - score           │
                            │  - time_used       │
                            │  - memory_used     │
                            │  - pass_rate       │
                            └────────────────────┘
                                       │
                                       ▼
                            ┌────────────────────┐
                            │ 10. 保存判题结果    │
                            │  submission_result │
                            │  每个测试用例一条   │
                            └────────────────────┘
                                       │
                                       ▼
                            ┌────────────────────┐
                            │ 11. 清理临时文件    │
                            │  - 源代码文件       │
                            │  - 可执行文件       │
                            └────────────────────┘
```

---

### 5.2 题目管理（Problem）详细设计

#### 5.2.1 数据表设计

**表名**：`problem`

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | bigint | - | √ | √ | AUTO_INCREMENT | 题目ID |
| title | varchar | 255 | - | √ | - | 题目标题 |
| description | text | - | - | √ | - | 题目描述（HTML/Markdown） |
| input_description | text | - | - | - | NULL | 输入描述 |
| output_description | text | - | - | - | NULL | 输出描述 |
| sample_input | text | - | - | - | NULL | 样例输入 |
| sample_output | text | - | - | - | NULL | 样例输出 |
| hint | text | - | - | - | NULL | 提示信息 |
| difficulty | tinyint | - | - | - | 1 | 难度：1-简单，2-中等，3-困难 |
| time_limit | int | - | - | √ | - | CPU时间限制（毫秒） |
| memory_limit | int | - | - | √ | - | 内存限制（MB） |
| stack_limit | int | - | - | - | 128 | 栈内存限制（MB） |
| source | varchar | 255 | - | - | NULL | 题目来源 |
| author_id | bigint | - | - | - | NULL | 出题人ID |
| accept_count | int | - | - | - | 0 | 通过次数 |
| submit_count | int | - | - | - | 0 | 提交次数 |
| status | tinyint | - | - | - | 0 | 状态：0-隐藏，1-公开 |
| deleted | tinyint | - | - | - | 0 | 删除标记 |
| create_time | datetime | - | - | - | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | - | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
```sql
PRIMARY KEY (`id`)
INDEX `idx_difficulty` (`difficulty`)
INDEX `idx_status` (`status`)
INDEX `idx_author_id` (`author_id`)
INDEX `idx_accept_count` (`accept_count`)
INDEX `idx_create_time` (`create_time`)
```

#### 5.2.2 实体类设计 (Problem.java)

```java
package com.emiyaoj.service.domain.pojo;

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;
import java.io.Serializable;
import java.time.LocalDateTime;

/**
 * 题目实体类
 */
@Data
@TableName("problem")
public class Problem implements Serializable {
    
    private static final long serialVersionUID = 1L;
    
    /**
     * 题目ID
     */
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private Long id;
    
    /**
     * 题目标题
     */
    private String title;
    
    /**
     * 题目描述（支持HTML/Markdown）
     */
    private String description;
    
    /**
     * 输入描述
     */
    private String inputDescription;
    
    /**
     * 输出描述
     */
    private String outputDescription;
    
    /**
     * 样例输入
     */
    private String sampleInput;
    
    /**
     * 样例输出
     */
    private String sampleOutput;
    
    /**
     * 提示信息
     */
    private String hint;
    
    /**
     * 难度：1-简单，2-中等，3-困难
     */
    private Integer difficulty;
    
    /**
     * CPU时间限制（毫秒）
     */
    private Integer timeLimit;
    
    /**
     * 内存限制（MB）
     */
    private Integer memoryLimit;
    
    /**
     * 栈内存限制（MB）
     */
    private Integer stackLimit;
    
    /**
     * 题目来源
     */
    private String source;
    
    /**
     * 出题人ID
     */
    private Long authorId;
    
    /**
     * 通过次数
     */
    private Integer acceptCount;
    
    /**
     * 提交次数
     */
    private Integer submitCount;
    
    /**
     * 状态：0-隐藏，1-公开
     */
    private Integer status;
    
    /**
     * 逻辑删除
     */
    @TableLogic
    private Integer deleted;
    
    /**
     * 创建时间
     */
    @TableField(fill = FieldFill.INSERT)
    private LocalDateTime createTime;
    
    /**
     * 更新时间
     */
    @TableField(fill = FieldFill.INSERT_UPDATE)
    private LocalDateTime updateTime;
}
```

#### 5.2.3 测试用例表设计

**表名**：`test_case`

| 字段名 | 数据类型 | 长度 | 主键 | 非空 | 默认值 | 说明 |
|--------|---------|------|------|------|--------|------|
| id | bigint | - | √ | √ | AUTO_INCREMENT | 测试用例ID |
| problem_id | bigint | - | - | √ | - | 题目ID |
| input | longtext | - | - | √ | - | 输入数据 |
| output | longtext | - | - | √ | - | 预期输出 |
| is_sample | tinyint | - | - | - | 0 | 是否为样例：0-否，1-是 |
| score | int | - | - | - | 0 | 分值（用于部分分题目） |
| sort_order | int | - | - | - | 0 | 排序 |
| deleted | tinyint | - | - | - | 0 | 删除标记 |
| create_time | datetime | - | - | - | CURRENT_TIMESTAMP | 创建时间 |
| update_time | datetime | - | - | - | CURRENT_TIMESTAMP | 更新时间 |

**索引设计**：
```sql
PRIMARY KEY (`id`)
INDEX `idx_problem_id` (`problem_id`)
INDEX `idx_is_sample` (`is_sample`)
```

#### 5.2.4 编程语言表设计

**表名**：`language`

| 字段名 | 数据类型 | 长度 | 非空 | 说明 |
|--------|---------|------|------|------|
| id | bigint | - | √ | 语言ID |
| name | varchar | 50 | √ | 语言名称（C, C++, Java） |
| version | varchar | 50 | √ | 版本（gcc-11, g++-11） |
| compile_command | text | - | - | 编译命令模板 |
| execute_command | text | - | √ | 执行命令模板 |
| source_file_ext | varchar | 20 | √ | 源文件扩展名（.c, .cpp） |
| executable_ext | varchar | 20 | - | 可执行文件扩展名 |
| is_compiled | tinyint | - | - | 是否需要编译：0-否，1-是 |
| time_limit_multiplier | decimal | (3,2) | - | 时间限制倍数 |
| memory_limit_multiplier | decimal | (3,2) | - | 内存限制倍数 |
| status | tinyint | - | - | 状态：0-禁用，1-启用 |

**示例数据**：
```sql
-- C语言
INSERT INTO `language` VALUES (1, 'C', 'gcc-11', 
  'gcc -o {{executable}} {{source}} -O2 -std=c11 -lm', 
  '{{executable}}', 
  '.c', '', 1, 1.00, 1.00, 1, NOW(), NOW());

-- C++语言
INSERT INTO `language` VALUES (2, 'C++', 'g++-11', 
  'g++ -o {{executable}} {{source}} -O2 -std=c++17', 
  '{{executable}}', 
  '.cpp', '', 1, 1.00, 1.00, 1, NOW(), NOW());
```

---

### 5.3 代码提交与判题详细设计

#### 5.3.1 提交记录表设计

**表名**：`submission`

| 字段名 | 数据类型 | 长度 | 说明 |
|--------|---------|------|------|
| id | bigint | - | 提交ID |
| problem_id | bigint | - | 题目ID |
| user_id | bigint | - | 用户ID |
| language_id | bigint | - | 语言ID |
| code | longtext | - | 源代码 |
| status | varchar | 50 | 判题状态（见枚举） |
| score | int | - | 得分（0-100） |
| time_used | int | - | 使用时间（毫秒） |
| memory_used | int | - | 使用内存（KB） |
| error_message | text | - | 错误信息 |
| compile_message | text | - | 编译信息 |
| pass_rate | varchar | 50 | 通过率（如"10/10"） |
| ip_address | varchar | 50 | 提交IP地址 |
| create_time | datetime | - | 提交时间 |
| update_time | datetime | - | 更新时间 |

**判题状态枚举**：
```java
public enum JudgeStatus {
    PENDING("Pending", "等待判题"),
    JUDGING("Judging", "判题中"),
    ACCEPTED("Accepted", "通过"),
    WRONG_ANSWER("Wrong Answer", "答案错误"),
    TIME_LIMIT_EXCEEDED("Time Limit Exceeded", "超时"),
    MEMORY_LIMIT_EXCEEDED("Memory Limit Exceeded", "内存超限"),
    RUNTIME_ERROR("Runtime Error", "运行时错误"),
    COMPILE_ERROR("Compile Error", "编译错误"),
    SYSTEM_ERROR("System Error", "系统错误");
    
    private final String code;
    private final String description;
}
```

#### 5.3.2 判题结果表设计

**表名**：`submission_result`

| 字段名 | 数据类型 | 说明 |
|--------|---------|------|
| id | bigint | 结果ID |
| submission_id | bigint | 提交ID |
| test_case_id | bigint | 测试用例ID |
| status | varchar(50) | 判题状态 |
| time_used | int | 使用时间（毫秒） |
| memory_used | int | 使用内存（KB） |
| error_message | text | 错误信息 |
| create_time | datetime | 创建时间 |

#### 5.3.3 提交DTO设计

```java
package com.emiyaoj.service.domain.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import lombok.Data;

/**
 * 代码提交DTO
 */
@Data
public class SubmitCodeDTO {
    
    /**
     * 题目ID
     */
    @NotNull(message = "题目ID不能为空")
    private Long problemId;
    
    /**
     * 语言ID
     */
    @NotNull(message = "语言ID不能为空")
    private Long languageId;
    
    /**
     * 源代码
     */
    @NotBlank(message = "代码不能为空")
    private String code;
}
```

#### 5.3.4 提交VO设计

```java
package com.emiyaoj.service.domain.vo;

import lombok.Data;
import java.time.LocalDateTime;
import java.util.List;

/**
 * 提交记录视图对象
 */
@Data
public class SubmissionVO {
    
    /**
     * 提交ID
     */
    private Long id;
    
    /**
     * 题目ID
     */
    private Long problemId;
    
    /**
     * 题目标题
     */
    private String problemTitle;
    
    /**
     * 用户ID
     */
    private Long userId;
    
    /**
     * 用户名
     */
    private String username;
    
    /**
     * 语言名称
     */
    private String languageName;
    
    /**
     * 源代码
     */
    private String code;
    
    /**
     * 判题状态
     */
    private String status;
    
    /**
     * 得分
     */
    private Integer score;
    
    /**
     * 使用时间（毫秒）
     */
    private Integer timeUsed;
    
    /**
     * 使用内存（KB）
     */
    private Integer memoryUsed;
    
    /**
     * 错误信息
     */
    private String errorMessage;
    
    /**
     * 编译信息
     */
    private String compileMessage;
    
    /**
     * 通过率（如"10/10"）
     */
    private String passRate;
    
    /**
     * 提交时间
     */
    private LocalDateTime createTime;
    
    /**
     * 详细判题结果列表
     */
    private List<SubmissionResultVO> results;
}
```

#### 5.3.5 GoJudgeService设计

```java
package com.emiyaoj.service.util;

import com.alibaba.fastjson2.JSON;
import com.alibaba.fastjson2.JSONObject;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.util.*;

/**
 * go-judge判题引擎服务类
 * 负责与go-judge沙箱进行HTTP通信，执行代码编译和运行
 */
@Slf4j
@Service
public class GoJudgeService {
    
    @Value("${GoJudge.url}")
    private String goJudgeUrl;
    
    private final RestTemplate restTemplate = new RestTemplate();
    
    /**
     * 编译代码
     * @param sourceCode 源代码
     * @param language 语言对象
     * @return 编译结果（包含可执行文件路径或错误信息）
     */
    public CompileResult compile(String sourceCode, Language language) {
        // 1. 生成临时源文件
        String sourceFileName = "Main" + language.getSourceFileExt();
        File sourceFile = createTempFile(sourceFileName, sourceCode);
        
        // 2. 构造编译命令
        String compileCmd = language.getCompileCommand()
            .replace("{{source}}", sourceFile.getAbsolutePath())
            .replace("{{executable}}", getExecutablePath(sourceFile));
        
        // 3. 构造go-judge请求
        Map<String, Object> request = new HashMap<>();
        request.put("cmd", Arrays.asList(new String[]{"/bin/sh", "-c", compileCmd}));
        request.put("cpuLimit", 10000000000L);  // 10秒
        request.put("memoryLimit", 268435456L);  // 256MB
        request.put("procLimit", 50);
        
        // 4. 发送编译请求
        try {
            String url = goJudgeUrl + "/run";
            String responseStr = restTemplate.postForObject(url, request, String.class);
            JSONObject response = JSON.parseObject(responseStr);
            
            // 5. 解析编译结果
            String status = response.getString("status");
            if ("Accepted".equals(status)) {
                return CompileResult.success(getExecutablePath(sourceFile));
            } else {
                String error = response.getString("error");
                String files = response.getString("files");
                return CompileResult.fail("编译失败：" + error + "\n" + files);
            }
        } catch (Exception e) {
            log.error("编译请求失败", e);
            return CompileResult.fail("系统错误：" + e.getMessage());
        }
    }
    
    /**
     * 执行代码
     * @param executablePath 可执行文件路径
     * @param input 输入数据
     * @param timeLimit 时间限制（毫秒）
     * @param memoryLimit 内存限制（MB）
     * @return 执行结果
     */
    public ExecuteResult execute(String executablePath, String input, 
                                  int timeLimit, int memoryLimit) {
        // 1. 构造执行命令
        Map<String, Object> request = new HashMap<>();
        request.put("cmd", Arrays.asList(new String[]{executablePath}));
        request.put("cpuLimit", timeLimit * 1000000L);  // 转为纳秒
        request.put("memoryLimit", memoryLimit * 1024 * 1024L);  // 转为字节
        request.put("procLimit", 1);
        
        // 2. 设置输入
        if (input != null && !input.isEmpty()) {
            Map<String, Object> file = new HashMap<>();
            file.put("content", Base64.getEncoder()
                .encodeToString(input.getBytes(StandardCharsets.UTF_8)));
            request.put("files", Collections.singletonMap("stdin", file));
            request.put("copyIn", Collections.singletonMap("stdin", file));
        }
        
        // 3. 设置输出文件
        request.put("copyOut", Arrays.asList("stdout", "stderr"));
        
        // 4. 发送执行请求
        try {
            String url = goJudgeUrl + "/run";
            String responseStr = restTemplate.postForObject(url, request, String.class);
            JSONObject response = JSON.parseObject(responseStr);
            
            // 5. 解析执行结果
            String status = response.getString("status");
            long time = response.getLongValue("time") / 1000000;  // 纳秒转毫秒
            long memory = response.getLongValue("memory") / 1024;  // 字节转KB
            
            // 6. 获取输出
            JSONObject files = response.getJSONObject("files");
            String output = "";
            if (files != null && files.containsKey("stdout")) {
                String content = files.getString("stdout");
                output = new String(Base64.getDecoder().decode(content), 
                                   StandardCharsets.UTF_8);
            }
            
            String error = "";
            if (files != null && files.containsKey("stderr")) {
                String content = files.getString("stderr");
                error = new String(Base64.getDecoder().decode(content), 
                                  StandardCharsets.UTF_8);
            }
            
            return ExecuteResult.builder()
                .status(status)
                .timeUsed((int) time)
                .memoryUsed((int) memory)
                .output(output)
                .error(error)
                .build();
                
        } catch (Exception e) {
            log.error("执行请求失败", e);
            return ExecuteResult.systemError(e.getMessage());
        }
    }
    
    /**
     * 创建临时文件
     */
    private File createTempFile(String fileName, String content) {
        try {
            File file = new File("/tmp/" + UUID.randomUUID() + "_" + fileName);
            try (FileWriter writer = new FileWriter(file)) {
                writer.write(content);
            }
            return file;
        } catch (IOException e) {
            throw new RuntimeException("创建临时文件失败", e);
        }
    }
    
    /**
     * 获取可执行文件路径
     */
    private String getExecutablePath(File sourceFile) {
        String path = sourceFile.getAbsolutePath();
        int dotIndex = path.lastIndexOf('.');
        return dotIndex > 0 ? path.substring(0, dotIndex) : path + ".out";
    }
}

/**
 * 编译结果类
 */
@Data
class CompileResult {
    private boolean success;
    private String executablePath;
    private String errorMessage;
    
    public static CompileResult success(String executablePath) {
        CompileResult result = new CompileResult();
        result.setSuccess(true);
        result.setExecutablePath(executablePath);
        return result;
    }
    
    public static CompileResult fail(String errorMessage) {
        CompileResult result = new CompileResult();
        result.setSuccess(false);
        result.setErrorMessage(errorMessage);
        return result;
    }
}

/**
 * 执行结果类
 */
@Data
@Builder
class ExecuteResult {
    private String status;
    private Integer timeUsed;
    private Integer memoryUsed;
    private String output;
    private String error;
    
    public static ExecuteResult systemError(String message) {
        return ExecuteResult.builder()
            .status("System Error")
            .error(message)
            .build();
    }
}
```

#### 5.3.6 SubmissionService核心逻辑

```java
@Service
@RequiredArgsConstructor
public class SubmissionServiceImpl implements ISubmissionService {
    
    private final SubmissionMapper submissionMapper;
    private final TestCaseMapper testCaseMapper;
    private final ProblemMapper problemMapper;
    private final LanguageMapper languageMapper;
    private final GoJudgeService goJudgeService;
    
    /**
     * 提交代码
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public Long submitCode(SubmitCodeDTO submitDTO) {
        // 1. 参数校验
        Problem problem = problemMapper.selectById(submitDTO.getProblemId());
        if (problem == null) {
            throw new BusinessException("题目不存在");
        }
        
        Language language = languageMapper.selectById(submitDTO.getLanguageId());
        if (language == null || language.getStatus() == 0) {
            throw new BusinessException("不支持的编程语言");
        }
        
        // 2. 获取当前用户ID
        Long userId = getCurrentUserId();
        
        // 3. 创建提交记录
        Submission submission = new Submission();
        submission.setProblemId(submitDTO.getProblemId());
        submission.setUserId(userId);
        submission.setLanguageId(submitDTO.getLanguageId());
        submission.setCode(submitDTO.getCode());
        submission.setStatus("Pending");
        submission.setScore(0);
        submissionMapper.insert(submission);
        
        // 4. 异步执行判题
        judgeAsync(submission.getId(), problem, language, submitDTO.getCode());
        
        return submission.getId();
    }
    
    /**
     * 异步判题
     */
    @Async
    public void judgeAsync(Long submissionId, Problem problem, 
                          Language language, String code) {
        // 更新状态为判题中
        updateSubmissionStatus(submissionId, "Judging");
        
        try {
            // 1. 编译代码（如需要）
            if (language.getIsCompiled() == 1) {
                CompileResult compileResult = goJudgeService.compile(code, language);
                if (!compileResult.isSuccess()) {
                    // 编译失败
                    updateSubmissionResult(submissionId, "Compile Error", 
                        compileResult.getErrorMessage());
                    return;
                }
            }
            
            // 2. 查询所有测试用例
            List<TestCase> testCases = testCaseMapper.selectByProblemId(
                problem.getId(), false);  // 不包括样例
            
            if (testCases.isEmpty()) {
                throw new BusinessException("题目没有测试用例");
            }
            
            // 3. 依次执行测试用例
            int passCount = 0;
            int totalCount = testCases.size();
            int maxTime = 0;
            int maxMemory = 0;
            
            for (TestCase testCase : testCases) {
                // 执行测试用例
                ExecuteResult execResult = goJudgeService.execute(
                    executablePath,
                    testCase.getInput(),
                    problem.getTimeLimit(),
                    problem.getMemoryLimit()
                );
                
                // 更新最大时间和内存
                maxTime = Math.max(maxTime, execResult.getTimeUsed());
                maxMemory = Math.max(maxMemory, execResult.getMemoryUsed());
                
                // 判断结果
                String status = judgeResult(execResult, testCase.getOutput());
                
                // 保存判题结果
                saveSubmissionResult(submissionId, testCase.getId(), 
                    status, execResult);
                
                if ("Accepted".equals(status)) {
                    passCount++;
                } else {
                    // 如果不是AC，终止判题
                    updateSubmissionFinal(submissionId, status, passCount, 
                        totalCount, maxTime, maxMemory, execResult.getError());
                    return;
                }
            }
            
            // 4. 全部通过
            updateSubmissionFinal(submissionId, "Accepted", passCount, 
                totalCount, maxTime, maxMemory, null);
                
        } catch (Exception e) {
            log.error("判题异常", e);
            updateSubmissionResult(submissionId, "System Error", 
                e.getMessage());
        }
    }
    
    /**
     * 判断执行结果
     */
    private String judgeResult(ExecuteResult execResult, String expectedOutput) {
        if (!"Accepted".equals(execResult.getStatus())) {
            // go-judge返回的状态不是AC
            return mapStatus(execResult.getStatus());
        }
        
        // 比较输出（去除首尾空白，统一换行符）
        String actual = normalizeOutput(execResult.getOutput());
        String expected = normalizeOutput(expectedOutput);
        
        if (actual.equals(expected)) {
            return "Accepted";
        } else {
            return "Wrong Answer";
        }
    }
    
    /**
     * 规范化输出（去除首尾空白）
     */
    private String normalizeOutput(String output) {
        if (output == null) return "";
        return output.trim().replaceAll("\\r\\n", "\\n");
    }
}
```

---

## 第3部分总结

本部分完成了在线判题模块的详细设计，包括：

1. **模块架构**：判题流程完整设计
2. **题目管理**：Problem表、TestCase表、Language表设计
3. **代码提交**：Submission表、SubmissionResult表设计
4. **判题引擎**：GoJudgeService与go-judge沙箱通信
5. **异步判题**：@Async异步执行判题逻辑
6. **结果判定**：编译、执行、输出比对完整流程

**下一部分预告：第4部分 - 博客模块与系统管理模块详细设计**

---

*EmiyaOJ详细设计文档 - 第3部分结束*
